# Интеграция платежей Telegram Stars

## Обзор

В этом документе описана реализация интеграции платежей Telegram Stars для премиум-подписок в боте AI-Companion. Интеграция позволяет пользователям приобретать премиум-доступ с помощью Telegram Stars, нативной платежной системы Telegram.

## Особенности

1. **Интеграция с Telegram Stars**: Полная интеграция с нативной платежной системой Telegram
2. **Планы премиум-подписки**: Несколько вариантов подписки с разными сроками действия
3. **Отслеживание платежей**: Хранение информации о всех транзакциях в базе данных
4. **Управление премиум-статусом**: Автоматическая активация и истечение срока действия премиум-подписок
5. **Многоязычная поддержка**: Платежные сообщения на русском и английском языках

## Архитектура

### Компоненты

1. **Модель платежей**: Модель базы данных для хранения информации о платежах
2. **Сервис платежей**: Бизнес-логика для обработки платежей и премиум-подписок
3. **Обработчики обратных вызовов**: Интеграция с системой обратных вызовов Telegram для инициации платежей
4. **Обработчики сообщений**: Обработка успешных платежей
5. **Конфигурация**: Настройки и параметры, связанные с платежами

### Поток данных

1. Пользователь выбирает план премиум в интерфейсе бота
2. Бот создает счет с помощью метода `send_invoice` Telegram
3. Пользователь завершает платеж в Telegram
4. Telegram отправляет событие `SuccessfulPayment` боту
5. Бот обрабатывает платеж и активирует премиум-подписку
6. Информация о платеже сохраняется в базе данных

## Детали реализации

### Модель платежей

Модель `Payment` хранит информацию о всех транзакциях:

- `id`: Внутренний ID платежа
- `user_id`: Ссылка на пользователя, совершившего платеж
- `amount`: Сумма в Telegram Stars
- `currency`: Код валюты (XTR для Telegram Stars)
- `payment_provider`: Платежный провайдер (telegram_stars)
- `payment_id`: ID платежа от Telegram
- `status`: Статус платежа (completed, refunded, failed)
- `created_at`: Временная метка создания платежа

### Сервис платежей

`TelegramStarsPaymentService` обрабатывает все операции, связанные с платежами:

- Создание счетов
- Обработка успешных платежей
- Активация/деактивация премиум-подписок
- Проверка статуса премиум

### Планы премиум

Бот предлагает три плана премиум-подписки:

1. **Ежемесячный**: 100 Telegram Stars на 30 дней
2. **Квартальный**: 250 Telegram Stars на 90 дней (скидка 15%)
3. **Годовой**: 800 Telegram Stars на 365 дней (скидка 30%)

### Конфигурация

Настройки платежей можно настроить через переменные окружения:

- `PAYMENT_ENABLED`: Включение/отключение функциональности платежей
- `PAYMENT_PROVIDER`: Платежный провайдер (telegram_stars)
- `PAYMENT_TEST_MODE`: Включение тестового режима

## Вопросы безопасности

1. **Валидация полезной нагрузки**: Все полезные нагрузки платежей проверяются для предотвращения подделки
2. **Верификация пользователей**: Платежи привязаны к конкретным пользователям для предотвращения мошенничества
3. **Обработка ошибок**: Комплексная обработка ошибок для предотвращения несогласованного состояния
4. **Логирование**: Подробное логирование всех платежных операций для целей аудита

## Тестирование

Модульные тесты охватывают все аспекты платежной системы:

- Создание счетов
- Обработка платежей
- Активация/деактивация премиум
- Проверка статуса
- Обработка ошибок

## Будущие улучшения

1. **Обработка возвратов**: Обработка событий возврата от Telegram
2. **Управление подписками**: Позволить пользователям управлять своими подписками
3. **Панель аналитики**: Административный интерфейс для просмотра статистики платежей
4. **Промокоды**: Поддержка скидочных кодов
5. **Подарочные подписки**: Позволить пользователям дарить премиум-подписки другим

## Справочник API

### TelegramStarsPaymentService

#### Методы

- `create_invoice(user_id, amount, description, duration_days)`: Создать счет на оплату
- `handle_successful_payment(payment, user_telegram_id)`: Обработать успешный платеж
- `activate_premium(user_id, duration_days)`: Активировать премиум-подписку
- `deactivate_premium(user_id)`: Деактивировать премиум-подписку
- `check_premium_status(user_id)`: Проверить статус премиум-подписки

## Устранение неполадок

### Распространенные проблемы

1. **Ошибка создания платежа**: Проверьте токен бота Telegram и конфигурацию платежей
2. **Платеж не обработан**: Проверьте конфигурацию вебхука и регистрацию обработчика платежей
3. **Премиум не активирован**: Проверьте подключение к базе данных и сопоставление ID пользователей

### Логи

Все платежные операции регистрируются с префиксом `payment.` в системе логов:

- `payment.invoice_created`: Счет успешно создан
- `payment.invoice_creation_error`: Ошибка создания счета
- `payment.payment_processed`: Платеж успешно обработан
- `payment.payment_handling_error`: Ошибка обработки платежа
- `payment.premium_activated`: Премиум-подписка активирована
- `payment.premium_activation_failed`: Не удалось активировать премиум-подписку
- `payment.premium_activation_error`: Ошибка активации премиум-подписки