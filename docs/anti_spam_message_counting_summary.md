# Реализация защиты от спама и подсчета сообщений

## Обзор

В рамках данного проекта была реализована система защиты от спама и подсчета сообщений для Telegram-бота AI-Компаньон. Система включает два основных компонента:

1. **AntiSpamMiddleware** - защита от спама с ограничением количества действий пользователя в минуту
2. **MessageCountingMiddleware** - подсчет сообщений с ограничением по дневному лимиту для бесплатных пользователей

## AntiSpamMiddleware

### Функциональность
- Ограничивает количество действий пользователя в минуту (по умолчанию 20 действий)
- При превышении лимита временно блокирует пользователя (по умолчанию на 10 секунд)
- Отправляет уведомление пользователю при превышении лимита
- Поддерживает настройку лимитов через конфигурационные параметры

### Конфигурация
- `SPAM_ACTIONS_PER_MINUTE` - количество действий в минуту (по умолчанию 20)
- `SPAM_RESTRICTION_DURATION` - длительность блокировки в секундах (по умолчанию 10)

### Техническая реализация
- Использует словарь для отслеживания действий пользователей
- Хранит временные блокировки пользователей
- Автоматически очищает устаревшие записи
- Поддерживает статистику по ограничениям

## MessageCountingMiddleware

### Функциональность
- Подсчитывает количество сообщений от пользователей
- Ограничивает количество сообщений в день для бесплатных пользователей (по умолчанию 20 сообщений)
- Премиум пользователи не имеют ограничений по количеству сообщений
- Автоматически сбрасывает счетчик в начале нового дня
- Отправляет уведомление при превышении дневного лимита с предложением приобрести премиум

### Конфигурация
- `DAILY_MESSAGE_LIMIT` - дневной лимит сообщений для бесплатных пользователей (по умолчанию 20)

### Техническая реализация
- Интегрирован с моделью пользователя для хранения счетчиков
- Обновляет счетчики в базе данных
- Поддерживает автоматический сброс счетчиков при наступлении нового дня
- Поддерживает статистику по обработанным сообщениям

## Интеграция

### Порядок выполнения Middleware
1. LoggingMiddleware (первым для записи всех событий)
2. AuthMiddleware (для получения пользователя)
3. AdminMiddleware (для проверки прав администратора)
4. UserLanguageMiddleware (для определения языка)
5. AntiSpamMiddleware (защита от спама)
6. RateLimitMiddleware (ограничение частоты запросов)
7. ConversationMiddleware (для сохранения диалогов)
8. MessageCountingMiddleware (для подсчета сообщений и ограничения по лимиту)
9. MetricsMiddleware (последним для сбора полной информации)

### Настройка
Все параметры можно настраивать через переменные окружения:
- `SPAM_ACTIONS_PER_MINUTE` - лимит действий в минуту для защиты от спама
- `SPAM_RESTRICTION_DURATION` - длительность блокировки при превышении лимита
- `DAILY_MESSAGE_LIMIT` - дневной лимит сообщений для бесплатных пользователей

## Тестирование

Реализованы unit-тесты для проверки корректности работы обоих middleware:
- Проверка работы в пределах лимитов
- Проверка срабатывания ограничений
- Проверка обработки премиум пользователей
- Проверка сброса счетчиков
- Проверка уведомлений пользователя

## Заключение

Система успешно реализована и протестирована. Она обеспечивает защиту от спама и справедливое распределение ресурсов между пользователями, при этом позволяя премиум пользователям пользоваться сервисом без ограничений.