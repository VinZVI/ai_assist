# Журнал изменений AI-Компаньон

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект следует [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [2025-10-09] - Исправление критических уязвимостей и улучшение безопасности
### Исправлено
- Исправлена уязвимость SQL-инъекции в функции create_database_if_not_exists путем добавления валидации имени базы данных
- Исправлен wildcard import в app/constants/__init__.py, заменен на явный импорт всех констант

## [2025-10-09] - Улучшение форматирования ответов AI и предотвращение проблем с Telegram
### Добавлено
- Добавлены инструкции в системный промпт AI для предотвращения генерации специальных символов и сообщений, превышающих лимит Telegram
- Созданы тесты для проверки корректности обновленных системных сообщений AI

### Изменено
- Обновлены системные сообщения в app/lexicon/ai_prompts.py для включения правил форматирования ответов
- Улучшена документация по обработке сообщений в README и других файлах документации

## [2025-10-07] - Исправление проблем с inline кнопками, добавление флага сохранения диалогов и улучшение обработки сообщений
### Добавлено
- Добавлен флаг CONVERSATION_ENABLE_SAVING в конфигурацию для управления сохранением диалогов (по умолчанию отключено)
- Добавлены недостающие обработчики callback для inline кнопок (start_chat, my_stats, help)
- Добавлена функция санитизации сообщений sanitize_telegram_message для очистки специальных символов из ответов AI
- Добавлены тесты для проверки корректной работы санитизации сообщений
- Добавлена проверка длины сообщений с ограничением в 4096 символов (лимит Telegram)
- Добавлены недостающие записи в лог-лексиконы для message_processed

### Исправлено
- Исправлена ошибка "Bad Request: can't parse entities" при отправке ответов AI с специальными символами
- Исправлены проблемы с работой inline кнопок из-за отсутствующих обработчиков callback
- Улучшена обработка ответов от OpenRouter API для предотвращения ошибок парсинга Telegram
- Исправлена проблема с отправкой сообщений, содержащих специальные теги типа "｜begin▁of▁sentence｜"
- Исправлена ошибка MISSING_LOG_TEXT: message.message_processed (lang=ru)
- Обновлена логика сохранения диалогов для использования флага конфигурации
- Улучшена функция sanitize_telegram_message для обработки дополнительных специальных символов

## [2025-10-07] - Исправление ошибки отправки сообщений в Telegram и улучшение обработки ответов AI
### Добавлено
- Добавлена функция санитизации сообщений для очистки специальных символов из ответов AI
- Добавлены тесты для проверки корректной работы санитизации сообщений
- Добавлена проверка длины сообщений с ограничением в 4096 символов (лимит Telegram)

### Исправлено
- Исправлена ошибка "Bad Request: can't parse entities" при отправке ответов AI с специальными символами
- Улучшена обработка ответов от OpenRouter API для предотвращения ошибок парсинга Telegram
- Исправлена проблема с отправкой сообщений, содержащих специальные теги типа "｜begin▁of▁sentence｜"

## [2025-10-07] - Удаление оставшихся ссылок на DeepSeek
### Удалено
- Удален файл диагностики DeepSeek API scripts/diagnostics/check_deepseek_api.py
- Удалены все оставшиеся ссылки на DeepSeek из конфигурационных файлов
- Удалены все оставшиеся ссылки на DeepSeek из тестов
- Удалены все оставшиеся ссылки на DeepSeek из скриптов диагностики
- Удалены все оставшиеся ссылки на DeepSeek из .env.example файла
- Полностью удалена поддержка DeepSeek API, включая HTTP клиент, тесты и всю связанную функциональность
- Удален провайдер DeepSeek из app/services/ai_providers/deepseek.py

### Изменено
- Обновлены конфигурационные файлы для работы только с OpenRouter
- Обновлены тесты для работы только с OpenRouter
- Обновлены скрипты диагностики для работы только с OpenRouter
- Обновлен .env.example файл для работы только с OpenRouter
- Обновлены все документационные файлы для отражения изменений

## [2025-10-07] - Рефакторинг системы AI и реализация fallback логики моделей
### Удалено
- Полностью удалена поддержка DeepSeek API, включая HTTP клиент, тесты и всю связанную функциональность
- Удален устаревший файл app/services/ai_service.py, который дублировал функциональность ai_manager.py
- Удалены тесты для устаревшего AI сервиса tests/integration/test_ai_service.py
- Удален провайдер DeepSeek из app/services/ai_providers/deepseek.py

### Добавлено
- Реализована поддержка нескольких моделей OpenRouter с fallback логикой
- Добавлена возможность указания списка моделей через переменную окружения OPENROUTER_MODEL
- Реализована логика последовательного переключения между моделями при ошибках
- Создан скрипт для проверки работы OpenRouter провайдера scripts/checks/test_openrouter_simple.py

### Изменено
- Обновлен AIManager для работы только с OpenRouter провайдером
- Обновлен OpenRouterProvider для поддержки нескольких моделей
- Обновлены конфигурационные файлы для парсинга списка моделей
- Обновлены тесты для отражения изменений в системе AI
- Обновлен app/services/__init__.py для удаления ссылок на удаленный сервис

## [2025-10-07] - Удаление устаревшего кода AI сервиса
### Удалено
- Удален устаревший файл app/services/ai_service.py, который дублировал функциональность ai_manager.py
- Удалены тесты для устаревшего AI сервиса tests/integration/test_ai_service.py
- Обновлен app/services/__init__.py для удаления ссылок на удаленный сервис

## [2025-10-07] - Исправление функции выбора языка
### Исправлено
- Исправлена функция установки другого языка
- Обновлены callback данные в клавиатуре выбора языка для соответствия обработчику
- Добавлены тесты для проверки корректной работы функции выбора языка

## [2025-10-07] - Исправление проблем с переводом интерфейса
### Исправлено
- Исправлена проблема с переводом inline клавиатур в стартовом сообщении
- Исправлена проблема с переводом ответов AI бота на выбранный пользователем язык
- Обновлены клавиатуры для использования системы лексиконов для перевода
- Обновлены обработчики сообщений для использования языковых предпочтений пользователя
- Исправлена функция get_or_update_user для сохранения языковых предпочтений пользователя

## [2025-10-07] - Исправление сохранения языковых предпочтений пользователя
### Исправлено
- Исправлена проблема с сохранением языковых предпочтений пользователя при отправке команды /start
- Обновлена функция get_or_create_user в app/handlers/start.py для сохранения пользовательского выбора языка
- Добавлены тесты для проверки сохранения языковых предпочтений

## [2025-10-07] - Добавление заглушек для команд /help, /profile, /limits и /premium
### Добавлено
- Реализованы заглушки для команд /help, /profile, /limits и /premium
- Созданы обработчики команд в отдельных файлах app/handlers/help.py, app/handlers/profile.py, app/handlers/limits.py и app/handlers/premium.py
- Добавлены записи в лог-лексиконы для новых обработчиков команд
- Обновлен handlers/__init__.py для регистрации новых роутеров
- Добавлены тесты для новых обработчиков команд в tests/test_new_commands.py

### Изменено
- Обновлена документация в changelog.md

## [2025-10-07] - Рефакторинг системы команд бота и реализация выбора языка
### Добавлено
- Реализована команда /language для выбора языка интерфейса
- Добавлен обработчик команды выбора языка в отдельном файле app/handlers/language.py
- Созданы тесты для функциональности выбора языка в tests/test_language.py
- Добавлены записи в лексиконы для функциональности выбора языка
- Добавлены записи в лог-лексиконы для функциональности выбора языка

### Изменено
- Обновлена система команд бота для использования описаний из лексиконов вместо hardcoded строк
- Команда /language добавлена в список команд бота
- Улучшена структура импортов в handlers/__init__.py

### Исправлено
- Исправлены ошибки типизации в обработчике команды выбора языка
- Устранены проблемы с доступом к сообщениям callback в обработчике языка

## [2025-10-07] - Завершение рефакторинга лог-лексиконов и исправление команд бота
### Добавлено
- Завершена миграция всех сообщений логирования на модульную систему лог-лексиконов
- Добавлены недостающие константы в лог-лексиконы для всех модулей

### Изменено
- Исправлены ошибки форматирования сообщений в обработчике команды /start
- Обновлены все обработчики для использования централизованной системы лог-лексиконов
- Улучшена структура импортов в лог-лексиконах
- Рефакторинг системы лог-лексиконов: удалены все отдельные файлы, оставлены только en.py и ru.py
- Все константы перемещены в словари в файлах en.py и ru.py

### Исправлено
- Исправлены проблемы с обработкой команд бота из-за неправильных параметров в лог-сообщениях
- Устранены hardcoded строки в лог-сообщениях по всему проекту
- Исправлены ошибки форматирования f-строк в лог-сообщениях

## [2025-10-05] - Настройка CI/CD pipeline и подготовка к продакшену
### Добавлено
- Созданы GitHub Actions workflows для CI/CD
- Добавлен workflow для security scanning
- Добавлен workflow для документации
- Созданы production environment файлы
- Созданы deployment скрипты
- Добавлена поддержка webhook режима

### Изменено
- Обновлена документация (README, Project.md, Tasktracker.md)
- Оптимизирован Dockerfile для продакшена
- Улучшена структура конфигурационных файлов

### Исправлено
- Улучшена безопасность хранения конфигураций

## [2025-10-03] - Расширение модульных лексиконов и констант
### Добавлено
- Созданы дополнительные файлы лексиконов для keyboards, ai_providers и utils модулей
- Созданы дополнительные файлы лог-лексиконов для keyboards, ai_providers и utils модулей
- Обновлены __init__.py файлы для обеспечения обратной совместимости

### Изменено
- Расширена структура модульных лексиконов в app/lexicon/
- Расширена структура модульных лог-лексиконов в app/log_lexicon/

## [2025-10-03] - Рефакторинг лексиконов и констант
### Добавлено
- Создана структура модульных лексиконов в app/lexicon/
- Созданы отдельные файлы лексиконов для start, message и callbacks хендлеров
- Создана структура модульных констант в app/constants/
- Созданы отдельные файлы констант для config и errors
- Создана структура модульных лог-лексиконов в app/log_lexicon/
- Созданы отдельные файлы лог-лексиконов для start, message и callbacks хендлеров

### Изменено
- Обновлены хендлеры для использования модульных лексиконов и констант
- Основные файлы lexicon.py, constants.py и log_lexicon.py помечены как устаревшие с предупреждениями

### Исправлено
- Улучшена структура кодовой базы для лучшей поддерживаемости

## [2025-09-27] - Добавление лог-лексикона и улучшение документации
### Добавлено
- Создан файл app/log_lexicon.py для централизованных сообщений логирования
- Добавлены подробные комментарии к файлам конфигурации

### Изменено
- Обновлена документация в docs/

## [2025-09-20] - Улучшение обработки ошибок AI и рефакторинг
### Добавлено
- Расширенная обработка ошибок для провайдеров AI
- Улучшенная система логирования для AI сервисов

### Изменено
- Рефакторинг обработчиков сообщений
- Улучшена система fallback для AI провайдеров

## [2025-09-15] - Добавление системы премиум-подписки
### Добавлено
- Система премиум-подписки с оплатой через Telegram Stars
- Лимиты для бесплатных пользователей
- Команда /premium для управления подпиской

## [2025-09-12] - Начальная реализация
### Добавлено
- Базовая структура проекта
- Интеграция с Telegram Bot API через aiogram
- Поддержка AI провайдера (OpenRouter)
- Система управления пользователями и диалогами
- Конфигурация через переменные окружения

---

*Версия документа: 1.1*
*Последнее обновление: 2025-10-07*