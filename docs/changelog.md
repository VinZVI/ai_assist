# Журнал изменений AI-Компаньон

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект следует [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [2025-10-17] - Исправление проблемы кэширования аутентификации и оптимизация производительности
### Исправлено
- Исправлена проблема с повторной аутентификацией пользователей при каждом сообщении
- Улучшена инициализация Redis кэша в AuthMiddleware для обеспечения доступности кэша до обработки первого сообщения
- Исправлен доступ MemoryCache к статистике Redis кэша через правильную передачу ссылки на Redis кэш
- Улучшена согласованность данных между кэшем и базой данных при обновлении активности пользователей
- Исправлена ошибка в UserService._update_user_activity_background_cached, где использовался user.id вместо user.telegram_id для операций с кэшем

### Добавлено
- Добавлены диагностические скрипты для проверки производительности кэширования и потока аутентификации
- Улучшена документация по архитектуре кэширования с описанием исправлений

## [2025-10-15] - Оптимизация кэширования и улучшение производительности UserService
### Добавлено
- UserService теперь обновляет кэш после изменения данных пользователей в базе данных
- Метод get_user_by_telegram_id теперь использует кэш для уменьшения количества запросов к базе данных
- Добавлены тесты для проверки корректности работы кэширования в UserService

### Изменено
- Обновлена документация по архитектуре кэширования (caching-architecture.md) с информацией об изменениях в UserService
- Улучшена согласованность данных между базой данных и кэшем в методах update_user, update_emotional_profile и update_support_preferences

## [2025-10-15] - Реализация функций эмоциональной поддержки и улучшение масштабируемости
### Добавлено
- Реализован EmotionalProfilingMiddleware для анализа эмоций пользователей и обновления их профилей
- Создан ContentFilterMiddleware для фильтрации контента и обеспечения безопасности
- Добавлены специализированные AI-подсказки для эмоциональной поддержки, вмешательства в кризисных ситуациях и работы с контентом для взрослых
- Реализована система мониторинга и аналитики для отслеживания производительности бота
- Добавлена поддержка горизонтального масштабирования с конфигурацией балансировки нагрузки
- Созданы расширенные конечные точки проверки работоспособности с системными метриками
- Реализована служба проверки работоспособности и мониторинга
- Добавлены тесты для всех новых компонентов эмоциональной поддержки
- Создана комплексная стратегия тестирования функций эмоциональной поддержки

### Изменено
- Улучшены обработчики сообщений для использования расширенного контекста эмоционального профилирования
- Обновлены премиум-функции с преимуществами эмоциональной поддержки
- Расширены системные метрики в веб-сервере с использованием psutil
- Улучшена служба разговоров для лучшего управления контекстом
- Обновлена основная документация (Project.md) с информацией о новых middleware компонентах

### Исправлено
- Исправлены проблемы с дублированием функциональности в обработчиках сообщений
- Улучшена архитектура проекта с разделением ответственности

## [2025-10-14] - Исправление тестов для платежной системы
### Исправлено
- Исправлены unit тесты для TelegramStarsPaymentService для корректной работы с асинхронными методами SQLAlchemy
- Добавлены недостающие await ключевые слова в методах activate_premium и check_premium_status
- Исправлены mock объекты в тестах для правильной работы с scalar_one_or_none()

## [2025-10-10] - Интеграция платежей Telegram Stars и система премиум подписки
### Добавлено
- Создана модель Payment для хранения информации о платежах
- Реализован TelegramStarsPaymentService для обработки платежей Telegram Stars
- Добавлена поддержка платежей в конфигурацию приложения
- Создана миграция базы данных для таблицы платежей
- Добавлены обработчики для создания инвойсов и обработки успешных платежей
- Созданы unit тесты для сервиса платежей
- Добавлены новые сообщения в лексиконы для поддержки платежей
- Создана документация по системе платежей (Payment.md)
- Обновлена основная документация (Project.md) с информацией о платежной системе

### Изменено
- Обновлены обработчики callback и сообщений для интеграции с платежной системой
- Расширены лог-лексиконы для поддержки логирования операций с платежами
- Обновлены модели User и Payment с необходимыми связями

## [2025-10-10] - Исправление дублирования функциональности health check и улучшение системы авторизации администраторов
### Добавлено
- Создан AdminMiddleware для централизованной проверки прав администратора
- Добавлены тесты для AdminMiddleware
- Добавлены тесты для админских и обычных обработчиков health check

### Изменено
- Перенесена логика проверки прав администратора из обработчиков в AdminMiddleware
- Упрощен обычный обработчик health check
- Админский обработчик health check теперь получает информацию о правах администратора через middleware
- Обновлены тесты для админского обработчика health check с учетом использования middleware

### Исправлено
- Исправлено дублирование функциональности между обычным и админским обработчиками health check
- Исправлены ошибки в тестах админского обработчика health check

## [2025-10-10] - Добавление админских команд и улучшение health check
### Добавлено
- Создан обработчик админских команд в app/handlers/admin.py
- Добавлена админская команда /health с расширенной информацией о состоянии системы
- Добавлены записи в лог-лексиконы для админских функций
- Добавлен обработчик admin_router в систему роутеров

### Изменено
- Обновлена документация (Project.md) с описанием нового обработчика админских команд
- Расширена функциональность проверки здоровья системы для администраторов

## [2025-10-09] - Перенос дублирующейся функциональности в систему Middleware
### Добавлено
- Создан UserLanguageMiddleware для управления языком пользователя
- Создан ConversationMiddleware для сохранения диалогов
- Создан UserCounterMiddleware для подсчета сообщений пользователей
- Добавлены тесты для новых компонентов middleware

### Изменено
- Обновлен обработчик сообщений для использования функций middleware вместо дублирующейся логики
- Удалена дублирующаяся функциональность из обработчика сообщений (сохранение диалогов, подсчет сообщений, управление языком)
- Обновлена документация (Project.md) с описанием новой системы middleware
- Обновлены обработчики для использования параметров из контекста middleware
- Обновлены тесты для соответствия новой архитектуре с middleware

### Исправлено
- Исправлены дубликаты логов при инициализации middleware
- Улучшена архитектура проекта с разделением ответственности

## [2025-10-09] - Исправление дублирования логики аутентификации и улучшение middleware
### Добавлено
- Добавлены тесты для AuthMiddleware и start handler

### Изменено
- Удалена дублирующаяся логика аутентификации из обработчика команды /start
- Обработчик команды /start теперь использует пользователя из контекста middleware
- Улучшена обработка пользовательских данных в AuthMiddleware
- Упрощена логика получения/обновления пользователей

### Исправлено
- Исправлена проблема с MISSING_LOG_TEXT для middleware registration
- Исправлены ошибки типизации в middleware и обработчиках

## [2025-10-09] - Реализация системы Middleware и улучшение архитектуры
### Добавлено
- Реализована система Middleware для централизованной обработки запросов
- Создан AuthMiddleware для автоматического получения/создания пользователей
- Создан RateLimitMiddleware для ограничения частоты запросов
- Создан LoggingMiddleware для централизованного логирования запросов
- Создан MetricsMiddleware для сбора метрик использования
- Добавлены тесты для всех компонентов middleware
- Улучшена обработка callback запросов в RateLimitMiddleware с отправкой уведомлений через answer()

### Изменено
- Обновлены обработчики сообщений и callback-запросов для использования middleware
- Удалена дублирующаяся функциональность из обработчиков (аутентификация, ограничение частоты запросов)
- Улучшена архитектура проекта с разделением ответственности
- Обновлена документация (Project.md) с описанием новой системы middleware

### Исправлено
- Исправлена обработка ограничения частоты запросов для всех типов событий
- Улучшена обработка ошибок в AuthMiddleware

## [2025-10-09] - Исправление критических уязвимостей и улучшение безопасности
### Исправлено
- Исправлена уязвимость SQL-инъекции в функции create_database_if_not_exists путем добавления валидации имени базы данных
- Исправлен wildcard import в app/constants/__init__.py, заменен на явный импорт всех констант

## [2025-10-09] - Улучшение форматирования ответов AI и предотвращение проблем с Telegram
### Добавлено
- Добавлены инструкции в системный промпт AI для предотвращения генерации специальных символов и сообщений, превышающих лимит Telegram
- Созданы тесты для проверки корректности обновленных системных сообщений AI

### Изменено
- Обновлены системные сообщения в app/lexicon/ai_prompts.py для включения правил форматирования ответов
- Улучшена документация по обработке сообщений в README и других файлах документации

## [2025-10-07] - Исправление проблем с inline кнопками, добавление флага сохранения диалогов и улучшение обработки сообщений
### Добавлено
- Добавлен флаг CONVERSATION_ENABLE_SAVING в конфигурацию для управления сохранением диалогов (по умолчанию отключено)
- Добавлены недостающие обработчики callback для inline кнопок (start_chat, my_stats, help)
- Добавлена функция санитизации сообщений sanitize_telegram_message для очистки специальных символов из ответов AI
- Добавлены тесты для проверки корректной работы санитизации сообщений
- Добавлена проверка длины сообщений с ограничением в 4096 символов (лимит Telegram)
- Добавлены недостающие записи в лог-лексиконы для message_processed

### Исправлено
- Исправлена ошибка "Bad Request: can't parse entities" при отправке ответов AI с специальными символами
- Исправлены проблемы с работой inline кнопок из-за отсутствующих обработчиков callback
- Улучшена обработка ответов от OpenRouter API для предотвращения ошибок парсинга Telegram
- Исправлена проблема с отправкой сообщений, содержащих специальные теги типа "｜begin▁of▁sentence｜"
- Исправлена ошибка MISSING_LOG_TEXT: message.message_processed (lang=ru)
- Обновлена логика сохранения диалогов для использования флага конфигурации
- Улучшена функция sanitize_telegram_message для обработки дополнительных специальных символов

## [2025-10-07] - Исправление ошибки отправки сообщений в Telegram и улучшение обработки ответов AI
### Добавлено
- Добавлена функция санитизации сообщений для очистки специальных символов из ответов AI
- Добавлены тесты для проверки корректной работы санитизации сообщений
- Добавлена проверка длины сообщений с ограничением в 4096 символов (лимит Telegram)

### Исправлено
- Исправлена ошибка "Bad Request: can't parse entities" при отправке ответов AI с специальными символами
- Улучшена обработка ответов от OpenRouter API для предотвращения ошибок парсинга Telegram
- Исправлена проблема с отправкой сообщений, содержащих специальные теги типа "｜begin▁of▁sentence｜"

## [2025-10-07] - Удаление оставшихся ссылок на DeepSeek
### Удалено
- Удален файл диагностики DeepSeek API scripts/diagnostics/check_deepseek_api.py
- Удалены все оставшиеся ссылки на DeepSeek из конфигурационных файлов
- Удалены все оставшиеся ссылки на DeepSeek из тестов
- Удалены все оставшиеся ссылки на DeepSeek из скриптов диагностики
- Удалены все оставшиеся ссылки на DeepSeek из .env.example файла
- Полностью удалена поддержка DeepSeek API, включая HTTP клиент, тесты и всю связанную функциональность
- Удален провайдер DeepSeek из app/services/ai_providers/deepseek.py

### Изменено
- Обновлены конфигурационные файлы для работы только с OpenRouter
- Обновлены тесты для работы только с OpenRouter
- Обновлены скрипты диагностики для работы только с OpenRouter
- Обновлен .env.example файл для работы только с OpenRouter