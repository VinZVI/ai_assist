# Журнал изменений AI-Компаньон

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект следует [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [2025-10-14] - Исправление тестов для платежной системы
### Исправлено
- Исправлены unit тесты для TelegramStarsPaymentService для корректной работы с асинхронными методами SQLAlchemy
- Добавлены недостающие await ключевые слова в методах activate_premium и check_premium_status
- Исправлены mock объекты в тестах для правильной работы с scalar_one_or_none()

## [2025-10-10] - Интеграция платежей Telegram Stars и система премиум подписки
### Добавлено
- Создана модель Payment для хранения информации о платежах
- Реализован TelegramStarsPaymentService для обработки платежей Telegram Stars
- Добавлена поддержка платежей в конфигурацию приложения
- Создана миграция базы данных для таблицы платежей
- Добавлены обработчики для создания инвойсов и обработки успешных платежей
- Созданы unit тесты для сервиса платежей
- Добавлены новые сообщения в лексиконы для поддержки платежей
- Создана документация по системе платежей (Payment.md)
- Обновлена основная документация (Project.md) с информацией о платежной системе

### Изменено
- Обновлены обработчики callback и сообщений для интеграции с платежной системой
- Расширены лог-лексиконы для поддержки логирования операций с платежами
- Обновлены модели User и Payment с необходимыми связями

## [2025-10-10] - Исправление дублирования функциональности health check и улучшение системы авторизации администраторов
### Добавлено
- Создан AdminMiddleware для централизованной проверки прав администратора
- Добавлены тесты для AdminMiddleware
- Добавлены тесты для админских и обычных обработчиков health check

### Изменено
- Перенесена логика проверки прав администратора из обработчиков в AdminMiddleware
- Упрощен обычный обработчик health check
- Админский обработчик health check теперь получает информацию о правах администратора через middleware
- Обновлены тесты для админского обработчика health check с учетом использования middleware

### Исправлено
- Исправлено дублирование функциональности между обычным и админским обработчиками health check
- Исправлены ошибки в тестах админского обработчика health check

## [2025-10-10] - Добавление админских команд и улучшение health check
### Добавлено
- Создан обработчик админских команд в app/handlers/admin.py
- Добавлена админская команда /health с расширенной информацией о состоянии системы
- Добавлены записи в лог-лексиконы для админских функций
- Добавлен обработчик admin_router в систему роутеров

### Изменено
- Обновлена документация (Project.md) с описанием нового обработчика админских команд
- Расширена функциональность проверки здоровья системы для администраторов

## [2025-10-09] - Перенос дублирующейся функциональности в систему Middleware
### Добавлено
- Создан UserLanguageMiddleware для управления языком пользователя
- Создан ConversationMiddleware для сохранения диалогов
- Создан UserCounterMiddleware для подсчета сообщений пользователей
- Добавлены тесты для новых компонентов middleware

### Изменено
- Обновлен обработчик сообщений для использования функций middleware вместо дублирующейся логики
- Удалена дублирующаяся функциональность из обработчика сообщений (сохранение диалогов, подсчет сообщений, управление языком)
- Обновлена документация (Project.md) с описанием новой системы middleware
- Обновлены обработчики для использования параметров из контекста middleware
- Обновлены тесты для соответствия новой архитектуре с middleware

### Исправлено
- Исправлены дубликаты логов при инициализации middleware
- Улучшена архитектура проекта с разделением ответственности

## [2025-10-09] - Исправление дублирования логики аутентификации и улучшение middleware
### Добавлено
- Добавлены тесты для AuthMiddleware и start handler

### Изменено
- Удалена дублирующаяся логика аутентификации из обработчика команды /start
- Обработчик команды /start теперь использует пользователя из контекста middleware
- Улучшена обработка пользовательских данных в AuthMiddleware
- Упрощена логика получения/обновления пользователей

### Исправлено
- Исправлена проблема с MISSING_LOG_TEXT для middleware registration
- Исправлены ошибки типизации в middleware и обработчиках

## [2025-10-09] - Реализация системы Middleware и улучшение архитектуры
### Добавлено
- Реализована система Middleware для централизованной обработки запросов
- Создан AuthMiddleware для автоматического получения/создания пользователей
- Создан RateLimitMiddleware для ограничения частоты запросов
- Создан LoggingMiddleware для централизованного логирования запросов
- Создан MetricsMiddleware для сбора метрик использования
- Добавлены тесты для всех компонентов middleware
- Улучшена обработка callback запросов в RateLimitMiddleware с отправкой уведомлений через answer()

### Изменено
- Обновлены обработчики сообщений и callback-запросов для использования middleware
- Удалена дублирующаяся функциональность из обработчиков (аутентификация, ограничение частоты запросов)
- Улучшена архитектура проекта с разделением ответственности
- Обновлена документация (Project.md) с описанием новой системы middleware

### Исправлено
- Исправлена обработка ограничения частоты запросов для всех типов событий
- Улучшена обработка ошибок в AuthMiddleware

## [2025-10-09] - Исправление критических уязвимостей и улучшение безопасности
### Исправлено
- Исправлена уязвимость SQL-инъекции в функции create_database_if_not_exists путем добавления валидации имени базы данных
- Исправлен wildcard import в app/constants/__init__.py, заменен на явный импорт всех констант

## [2025-10-09] - Улучшение форматирования ответов AI и предотвращение проблем с Telegram
### Добавлено
- Добавлены инструкции в системный промпт AI для предотвращения генерации специальных символов и сообщений, превышающих лимит Telegram
- Созданы тесты для проверки корректности обновленных системных сообщений AI

### Изменено
- Обновлены системные сообщения в app/lexicon/ai_prompts.py для включения правил форматирования ответов
- Улучшена документация по обработке сообщений в README и других файлах документации

## [2025-10-07] - Исправление проблем с inline кнопками, добавление флага сохранения диалогов и улучшение обработки сообщений
### Добавлено
- Добавлен флаг CONVERSATION_ENABLE_SAVING в конфигурацию для управления сохранением диалогов (по умолчанию отключено)
- Добавлены недостающие обработчики callback для inline кнопок (start_chat, my_stats, help)
- Добавлена функция санитизации сообщений sanitize_telegram_message для очистки специальных символов из ответов AI
- Добавлены тесты для проверки корректной работы санитизации сообщений
- Добавлена проверка длины сообщений с ограничением в 4096 символов (лимит Telegram)
- Добавлены недостающие записи в лог-лексиконы для message_processed

### Исправлено
- Исправлена ошибка "Bad Request: can't parse entities" при отправке ответов AI с специальными символами
- Исправлены проблемы с работой inline кнопок из-за отсутствующих обработчиков callback
- Улучшена обработка ответов от OpenRouter API для предотвращения ошибок парсинга Telegram
- Исправлена проблема с отправкой сообщений, содержащих специальные теги типа "｜begin▁of▁sentence｜"
- Исправлена ошибка MISSING_LOG_TEXT: message.message_processed (lang=ru)
- Обновлена логика сохранения диалогов для использования флага конфигурации
- Улучшена функция sanitize_telegram_message для обработки дополнительных специальных символов

## [2025-10-07] - Исправление ошибки отправки сообщений в Telegram и улучшение обработки ответов AI
### Добавлено
- Добавлена функция санитизации сообщений для очистки специальных символов из ответов AI
- Добавлены тесты для проверки корректной работы санитизации сообщений
- Добавлена проверка длины сообщений с ограничением в 4096 символов (лимит Telegram)

### Исправлено
- Исправлена ошибка "Bad Request: can't parse entities" при отправке ответов AI с специальными символами
- Улучшена обработка ответов от OpenRouter API для предотвращения ошибок парсинга Telegram
- Исправлена проблема с отправкой сообщений, содержащих специальные теги типа "｜begin▁of▁sentence｜"

## [2025-10-07] - Удаление оставшихся ссылок на DeepSeek
### Удалено
- Удален файл диагностики DeepSeek API scripts/diagnostics/check_deepseek_api.py
- Удалены все оставшиеся ссылки на DeepSeek из конфигурационных файлов
- Удалены все оставшиеся ссылки на DeepSeek из тестов
- Удалены все оставшиеся ссылки на DeepSeek из скриптов диагностики
- Удалены все оставшиеся ссылки на DeepSeek из .env.example файла
- Полностью удалена поддержка DeepSeek API, включая HTTP клиент, тесты и всю связанную функциональность
- Удален провайдер DeepSeek из app/services/ai_providers/deepseek.py

### Изменено
- Обновлены конфигурационные файлы для работы только с OpenRouter
- Обновлены тесты для работы только с OpenRouter
- Обновлены скрипты диагностики для работы только с OpenRouter
- Обновлен .env.example файл для работы только с OpenRouter
- Обновлены все документационные файлы для отражения изменений

## [2025-10-07] - Рефакторинг системы AI и реализация fallback логики моделей
### Удалено
- Полностью удалена поддержка DeepSeek API, включая HTTP клиент, тесты и всю связанную функциональность
- Удален устаревший файл app/services/ai_service.py, который дублировал функциональность ai_manager.py
- Удалены тесты для устаревшего AI сервиса tests/integration/test_ai_service.py
- Удален провайдер DeepSeek из app/services/ai_providers/deepseek.py

### Добавлено
- Реализована поддержка нескольких моделей OpenRouter с fallback логикой
- Добавлена возможность указания списка моделей через переменную окружения OPENROUTER_MODEL
- Реализована логика последовательного переключения между моделями при ошибках
- Создан скрипт для проверки работы OpenRouter провайдера scripts/checks/test_openrouter_simple.py

### Изменено
- Обновлен AIManager для работы только с OpenRouter провайдером
- Обновлен OpenRouterProvider для поддержки нескольких моделей
- Обновлены конфигурационные файлы для парсинга списка моделей
- Обновлены тесты для отражения изменений в системе AI
- Обновлен app/services/__init__.py для удаления ссылок на удаленный сервис

## [2025-10-07] - Удаление устаревшего кода AI сервиса
### Удалено
- Удален устаревший файл app/services/ai_service.py, который дублировал функциональность ai_manager.py
- Удалены тесты для устаревшего AI сервиса tests/integration/test_ai_service.py
- Обновлен app/services/__init__.py для удаления ссылок на удаленный сервис

## [2025-10-07] - Исправление функции выбора языка
### Исправлено
- Исправлена функция установки другого языка
- Обновлены callback данные в клавиатуре выбора языка для соответствия обработчику
- Добавлены тесты для проверки корректной работы функции выбора языка

## [2025-10-07] - Исправление проблем с переводом интерфейса
### Исправлено
- Исправлена проблема с переводом inline клавиатур в стартовом сообщении
- Исправлена проблема с переводом ответов AI бота на выбранный пользователем язык
- Обновлены клавиатуры для использования системы лексиконов для перевода
- Обновлены обработчики сообщений для использования языковых предпочтений пользователя
- Исправлена функция get_or_update_user для сохранения языковых предпочтений пользователя

## [2025-10-07] - Исправление сохранения языковых предпочтений пользователя
### Исправлено
- Исправлена проблема с сохранением языковых предпочтений пользователя при отправке команды /start
- Обновлена функция get_or_create_user в app/handlers/start.py для сохранения пользовательского выбора языка
- Добавлены тесты для проверки сохранения языковых предпочтений

## [2025-10-07] - Добавление заглушек для команд /help, /profile, /limits и /premium
### Добавлено
- Реализованы заглушки для команд /help, /profile, /limits и /premium
- Созданы обработчики команд в отдельных файлах app/handlers/help.py, app/handlers/profile.py, app/handlers/limits.py и app/handlers/premium.py
- Добавлены записи в лог-лексиконы для новых обработчиков команд
- Обновлен handlers/__init__.py для регистрации новых роутеров
- Добавлены тесты для новых обработчиков команд в tests/test_new_commands.py

### Изменено
- Обновлена документация в changelog.md

## [2025-10-07] - Рефакторинг системы команд бота и реализация выбора языка
### Добавлено
- Реализована команда /language для выбора языка интерфейса
- Добавлен обработчик команды выбора языка в отдельном файле app/handlers/language.py
- Созданы тесты для функциональности выбора языка в tests/test_language.py
- Добавлены записи в лексиконы для функциональности выбора языка
- Добавлены записи в лог-лексиконы для функциональности выбора языка

### Изменено
- Обновлена система команд бота для использования описаний из лексиконов вместо hardcoded строк
- Команда /language добавлена в список команд бота
- Улучшена структура импортов в handlers/__init__.py

### Исправлено
- Исправлены ошибки типизации в обработчике команды выбора языка
- Устранены проблемы с доступом к сообщениям callback в обработчике языка

## [2025-10-07] - Завершение рефакторинга лог-лексиконов и исправление команд бота
### Добавлено
- Завершена миграция всех сообщений логирования на модульную систему лог-лексиконов
- Добавлены недостающие константы в лог-лексиконы для всех модулей

### Изменено
- Исправлены ошибки форматирования сообщений в обработчике команды /start
- Обновлены все обработчики для использования централизованной системы лог-лексиконов
- Улучшена структура импортов в лог-лексиконах
- Рефакторинг системы лог-лексиконов: удалены все отдельные файлы, оставлены только en.py и ru.py
- Все константы перемещены в словари в файлах en.py и ru.py

### Исправлено
- Исправлены проблемы с обработкой команд бота из-за неправильных параметров в лог-сообщениях
- Устранены hardcoded строки в лог-сообщениях по всему проекту
- Исправлены ошибки форматирования f-строк в лог-сообщениях

## [2025-10-05] - Настройка CI/CD pipeline и подготовка к продакшену
### Добавлено
- Созданы GitHub Actions workflows для CI/CD
- Добавлен workflow для security scanning
- Добавлен workflow для документации
- Созданы production environment файлы
- Созданы deployment скрипты
- Добавлена поддержка webhook режима