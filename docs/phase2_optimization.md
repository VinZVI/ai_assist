# Фаза 2: Устранение циркулярных импортов и оптимизация производительности

## Обзор

Фаза 2 проекта направлена на устранение архитектурных проблем и оптимизацию производительности системы. Основные задачи включают устранение циркулярных импортов, добавление индексов базы данных, реализацию пакетной обработки операций и создание системы мониторинга производительности.

## Задачи фазы

### 1. Устранение циркулярных импортов

#### Цель
Рефакторинг кода для устранения циркулярных импортов и улучшения архитектуры модулей.

#### Компоненты
- **Система dependency injection** (`app/core/dependencies.py`)
  - Контейнер для управления зависимостями приложения
  - Регистрация singleton сервисов и factory
  - Декораторы для внедрения зависимостей

- **Реестр сервисов** (`app/core/service_registry.py`)
  - Централизованная инициализация всех сервисов
  - Управление порядком инициализации зависимостей

- **Новый сервис диалогов** (`app/services/conversation_service_new.py`)
  - Рефакторинг conversation_service без циркулярных импортов
  - Использование dependency injection для получения зависимостей

#### Преимущества
- Устранение циркулярных импортов
- Улучшенная тестируемость компонентов
- Гибкость конфигурации сервисов
- Централизованное управление зависимостями

### 2. Добавление дополнительных индексов БД

#### Цель
Создание дополнительных индексов для оптимизации производительности запросов к базе данных.

#### Индексы
- Составной индекс для получения последних диалогов пользователя
- Индекс для фильтрации по статусу и времени обработки
- Индекс для аналитики по моделям ИИ
- Индекс для подсчета токенов по пользователям
- Составной индекс для активных премиум пользователей
- Индекс для поиска пользователей по последней активности
- Индекс для дневной статистики сообщений
- Частичный индекс для заблокированных пользователей

#### Утилиты оптимизации
- **Анализ производительности запросов** (`app/utils/db_optimization.py`)
- **Проверка на отсутствующие индексы**
- **Обслуживание таблиц** (VACUUM, ANALYZE)
- **Генерация отчетов по оптимизации**

### 3. Батчинг операций сохранения

#### Цель
Реализация пакетного сохранения диалогов для уменьшения количества запросов к базе данных.

#### Компоненты
- **Пакетный процессор** (`app/services/batch_processor.py`)
  - Пакетная вставка диалогов
  - Пакетное обновление пользователей
  - Механизмы retry при ошибках
  - Настраиваемые параметры батчинга

- **Менеджер фоновых задач** (`app/core/background_tasks.py`)
  - Управление фоновыми процессами
  - Мониторинг состояния системы
  - Очистка кэша и других ресурсов

#### Преимущества
- Снижение нагрузки на БД
- Увеличение пропускной способности
- Улучшенная отказоустойчивость
- Механизмы повторных попыток при ошибках

### 4. Мониторинг производительности

#### Цель
Создание системы мониторинга производительности с метриками, алертами и дашбордом.

#### Компоненты
- **Монитор производительности** (`app/services/performance_monitor.py`)
  - Сбор системных метрик (CPU, память, диск)
  - Сбор метрик приложения (кэш, батч-процессор)
  - Сбор метрик базы данных
  - Система алертов для критичных метрик

- **Коллектор метрик** (`app/services/metrics_collector.py`)
  - Трекинг различных операций в системе
  - Декораторы для измерения времени выполнения
  - Контекстные менеджеры для тайминга

- **Веб-дашборд метрик** (`app/web.py`)
  - Визуализация метрик в реальном времени
  - Отображение активных алертов
  - API эндпоинты для получения метрик

#### Метрики
- Системные метрики (CPU, память, диск)
- Метрики приложения (кэш, батч-процессор)
- Метрики базы данных
- Метрики middleware компонентов
- Метрики пользовательских действий

#### Алерты
- Высокое использование памяти
- Высокая нагрузка на CPU
- Медленные запросы к БД
- Низкий hit rate кэша
- Высокая очередь батч-процессора
- Всплески ошибок

## План реализации

### Неделя 1
1. Реализация системы dependency injection
2. Создание реестра сервисов
3. Рефакторинг conversation_service
4. Обновление middleware компонентов

### Неделя 2
1. Добавление дополнительных индексов БД
2. Реализация утилит оптимизации БД
3. Создание пакетного процессора
4. Реализация менеджера фоновых задач

### Неделя 3
1. Интеграция батчинга в основные сервисы
2. Реализация монитора производительности
3. Создание коллектора метрик
4. Разработка веб-дашборда

## Ожидаемые результаты

1. **Устранение архитектурных проблем**
   - Полное устранение циркулярных импортов
   - Улучшенная модульность кода
   - Повышенная тестируемость компонентов

2. **Оптимизация производительности**
   - Увеличение скорости запросов к БД на 30-50%
   - Снижение нагрузки на БД за счет батчинга операций
   - Улучшенное использование системных ресурсов

3. **Улучшенный мониторинг**
   - Визуализация метрик в реальном времени
   - Система алертов для критичных метрик
   - Возможность диагностики проблем производительности

4. **Повышенная надежность**
   - Механизмы повторных попыток при ошибках
   - Улучшенная обработка исключительных ситуаций
   - Фоновые задачи для обслуживания системы