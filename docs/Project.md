# AI-Компаньон: Telegram-бот для эмоциональной поддержки

## 1. Общие сведения о проекте

### 1.1 Назначение системы

Telegram-бот для предоставления эмоциональной поддержки и психологического комфорта пользователям с интеграцией DeepSeek API для генерации ответов на базе искусственного интеллекта.

### 1.2 Цели проекта

- Создание масштабируемого сервиса для психологической поддержки
- Обеспечение высокой доступности (99.9% uptime)
- Монетизация через премиум функции
- Создание MVP в течение 4-6 недель

## 2. Технический стек и архитектура

### 2.1 Основной стек технологий

```
Backend Framework: aiogram 3.x (асинхронный фреймворк для Telegram Bot API)
Language: Python 3.11+
Database: PostgreSQL 15+ (основная БД)
ORM: SQLAlchemy 2.0+ с async поддержкой
Migration Tool: Alembic
HTTP Client: httpx (для DeepSeek API)
Environment: python-dotenv
Validation: Pydantic v2.11.7
Logging: Loguru
Dependency Management: uv
```

### 2.2 Архитектурные компоненты

**Слой представления:**
- Telegram Bot API Handler (aiogram dispatcher)
- Webhook/Polling механизм обработки обновлений
- Middleware для аутентификации и rate limiting

**Бизнес-логика:**
- Conversation Manager (управление диалогами)
- AI Response Generator (интеграция с DeepSeek)
- User State Management (управление состояниями пользователей)
- Payment Processing (обработка платежей)

**Слой данных:**
- Database Abstraction Layer (SQLAlchemy ORM)
- Repository Pattern для работы с данными

### 2.3 Структура проекта

```
ai_assist/
├── app/                        # Основной пакет приложения
│   ├── __init__.py            # Инициализация пакета
│   ├── main.py                # Точка входа
│   ├── config.py              # Настройки приложения
│   ├── database.py            # Подключение к БД
│   ├── models/                # Модели данных
│   │   ├── __init__.py
│   │   ├── user.py           # Модель пользователя
│   │   └── conversation.py   # Модель диалога
│   ├── handlers/              # Обработчики команд
│   │   ├── __init__.py
│   │   ├── start.py          # /start команда
│   │   ├── language.py       # /language команда
│   │   ├── help.py           # /help команда
│   │   ├── profile.py        # /profile команда
│   │   ├── limits.py         # /limits команда
│   │   ├── premium.py        # /premium команда
│   │   ├── message.py        # Обработка сообщений
│   │   ├── callbacks.py      # Обработка callback-запросов
│   │   └── health.py         # Healthcheck endpoint
│   ├── services/              # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── ai_manager.py     # Менеджер AI провайдеров (единственный AI сервис)
│   │   ├── conversation_service.py # Сервис работы с диалогами
│   │   ├── user_service.py   # Логика пользователей
│   │   └── ai_providers/     # Провайдеры AI
│   │       ├── __init__.py
│   │       ├── base.py       # Базовый класс провайдера
│   │       ├── deepseek.py   # DeepSeek провайдер
│   │       └── openrouter.py # OpenRouter провайдер
│   ├── utils/                 # Утилиты
│   │   ├── __init__.py
│   │   └── logging.py        # Система логирования
│   ├── keyboards/             # Клавиатуры
│   │   └── __init__.py       # Inline клавиатуры
│   ├── constants/             # Константы (модульная структура)
│   │   ├── __init__.py
│   │   ├── config.py         # Константы конфигурации
│   │   └── errors.py         # Константы ошибок
│   ├── lexicon/               # Лексиконы (модульная структура)
│   │   ├── __init__.py
│   │   ├── gettext.py        # Функции локализации
│   │   ├── ru.py             # Русский лексикон
│   │   └── en.py             # Английский лексикон
│   └── log_lexicon/           # Лог-лексиконы (модульная структура)
│       ├── __init__.py
│       ├── en.py             # Английский лог-лексикон (словарная структура)
│       └── ru.py             # Русский лог-лексикон (словарная структура)
├── tests/                      # Тесты приложения
│   ├── __init__.py            # Инициализация пакета тестов
│   ├── conftest.py           # Конфигурация pytest
│   ├── fixtures/             # Фикстуры для тестов
│   ├── unit/                 # Модульные тесты
│   └── integration/          # Интеграционные тесты
├── scripts/                    # Скрипты диагностики
│   ├── __init__.py
│   ├── checks/               # Скрипты проверки
│   └── diagnostics/          # Диагностические скрипты
├── docs/                      # Документация
│   ├── Project.md            # Описание проекта (этот файл)
│   ├── Tasktracker.md        # Отслеживание задач
│   ├── Diary.md              # Дневник разработки
│   ├── Testing.md            # Документация по тестированию
│   ├── Deployment.md         # Документация по деплою
│   ├── Docker.md             # Документация по Docker
│   ├── qa.md                 # Вопросы и ответы
│   └── changelog.md          # Журнал изменений
├── alembic/                    # Миграции базы данных
├── logs/                       # Логи приложения
├── .github/                    # GitHub Actions workflows
├── pyproject.toml            # Конфигурация проекта и зависимости
├── pytest.ini               # Конфигурация тестирования
├── .env.example              # Пример переменных окружения
├── docker-compose.yml        # Docker конфигурация
└── README.md                 # Основное описание проекта
```

## 3. AI сервис и интеграция

### 3.1 Архитектура AI сервиса с несколькими провайдерами

**Система поддерживает множественных AI провайдеров с автоматическим fallback:**

**Основные компоненты:**
- `AIManager` - центральный менеджер для управления несколькими провайдерами
- `BaseAIProvider` - абстрактный базовый класс для всех провайдеров
- `DeepSeekProvider` - провайдер для DeepSeek API
- `OpenRouterProvider` - провайдер для OpenRouter API
- `ResponseCache` - система кеширования ответов с поддержкой нескольких провайдеров
- `ConversationMessage` - структура для сообщений диалога
- `AIResponse` - структура ответа от AI

**Поддерживаемые провайдеры:**
1. **DeepSeek API** - основной провайдер
2. **OpenRouter API** - резервный провайдер с доступом к множественным моделям

**Особенности реализации:**
- Автоматический fallback между провайдерами
- Асинхронная работа с httpx клиентом
- Retry логика с экспоненциальной задержкой
- Обработка различных типов ошибок (401, 402, 429, 5xx)
- Кеширование ответов на основе MD5 хешей с учетом провайдера
- Мониторинг состояния через `health_check()` для всех провайдеров
- Статистика использования и fallback событий

### 3.2 Конфигурация AI сервиса

```
# Настройки DeepSeek API
DEEPSEEK_API_KEY=your_api_key_here
DEEPSEEK_BASE_URL=https://api.deepseek.com
DEEPSEEK_MODEL=deepseek-chat
DEEPSEEK_MAX_TOKENS=1000
DEEPSEEK_TEMPERATURE=0.7
DEEPSEEK_TIMEOUT=30

# Настройки OpenRouter API
OPENROUTER_API_KEY=your_openrouter_api_key_here
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
OPENROUTER_MODEL=anthropic/claude-3-haiku
OPENROUTER_MAX_TOKENS=1000
OPENROUTER_TEMPERATURE=0.8
OPENROUTER_TIMEOUT=60
OPENROUTER_SITE_URL=https://your-site.com
OPENROUTER_APP_NAME=AI-Assistant-Bot

# Настройки AI менеджера
AI_PRIMARY_PROVIDER=openrouter
AI_FALLBACK_PROVIDER=deepseek
AI_ENABLE_FALLBACK=true

# Настройки кеширования
CACHE_TTL=3600
```

### 3.3 Обработка ошибок и Fallback система

**Иерархия ошибок:**
- `AIProviderError` - базовый класс ошибок провайдеров
- `APIConnectionError` - ошибки подключения
- `APIRateLimitError` - превышение лимитов
- `APIAuthenticationError` - ошибки аутентификации
- `APIQuotaExceededError` - превышение квоты/недостаток средств

**Автоматическая Fallback стратегия:**
1. Попытка обращения к основному провайдеру (настраивается в AI_PRIMARY_PROVIDER)
2. При временных ошибках (сеть, rate limit) - автоматическое переключение на резервный провайдер
3. При критических ошибках (аутентификация, квота) - остановка без fallback
4. Логирование всех fallback событий для мониторинга
5. Статистика успешности провайдеров

## 4. Система локализации и интернационализации

### 4.1 Модульная система лексиконов

Проект использует модульную систему лексиконов для поддержки нескольких языков:

- **Центральный файл локализации**: `app/lexicon/gettext.py` содержит функции `get_text()` и `get_log_text()` для получения локализованных строк
- **Языковые файлы**: `app/lexicon/ru.py` и `app/lexicon/en.py` содержат все пользовательские сообщения
- **Лог-лексиконы**: `app/log_lexicon/ru.py` и `app/log_lexicon/en.py` содержат все сообщения для логирования

### 4.2 Поддержка многоязычности

**Особенности реализации:**
- Автоматическое определение языка пользователя при первом взаимодействии
- Возможность ручного выбора языка через команду `/language`
- Сохранение языковых предпочтений пользователя в базе данных
- Корректное сохранение языковых предпочтений при повторных вызовах команды `/start`

**Поддерживаемые языки:**
1. Русский (ru) - язык по умолчанию
2. Английский (en)

### 4.3 Команды бота с поддержкой локализации

**Реализованные команды:**
- `/start` - начальное приветствие и регистрация пользователя
- `/language` - выбор языка интерфейса
- `/help` - справка по командам бота (заглушка)
- `/profile` - информация о профиле пользователя (заглушка)
- `/limits` - информация о лимитах сообщений (заглушка)
- `/premium` - информация о премиум-доступе (заглушка)

## 5. Система премиум-подписки

### 5.1 Монетизация через Telegram Stars

**Особенности реализации:**
- Платежи через встроенную систему Telegram Stars
- Лимиты для бесплатных пользователей (настраиваемые)
- Неограниченное общение для премиум пользователей
- Автоматическое управление статусом подписки

### 5.2 Лимиты пользователей

**Бесплатные пользователи:**
- Ограниченное количество сообщений в день (настраиваемое значение)
- Доступ ко всем базовым функциям бота

**Премиум пользователи:**
- Неограниченное количество сообщений
- Приоритетная обработка запросов
- Ранний доступ к новым функциям

## 6. Тестирование и качество кода

### 6.1 Система тестирования

**Типы тестов:**
- Модульные тесты для отдельных компонентов
- Интеграционные тесты для проверки взаимодействия компонентов
- Тесты обработчиков команд Telegram
- Тесты AI сервисов и провайдеров

**Инструменты:**
- `pytest` - фреймворк для тестирования
- `unittest.mock` - моки для изоляции компонентов
- `coverage` - измерение покрытия кода тестами

### 6.2 Контроль качества кода

**Инструменты:**
- `ruff` - линтер и форматтер кода
- `mypy` - статическая типизация
- `black` - форматирование кода
- `isort` - сортировка импортов

**Pre-commit хуки:**
- Автоматическая проверка кода перед коммитом
- Форматирование кода
- Проверка типов
- Запуск тестов
