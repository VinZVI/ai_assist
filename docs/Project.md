# AI-Компаньон: Telegram-бот для эмоциональной поддержки

## 1. Общие сведения о проекте

### 1.1 Назначение системы

Telegram-бот для предоставления эмоциональной поддержки и психологического комфорта пользователям с интеграцией OpenRout API для генерации ответов на базе искусственного интеллекта.

### 1.2 Цели проекта

- Создание масштабируемого сервиса для психологической поддержки
- Обеспечение высокой доступности (99.9% uptime)
- Монетизация через премиум функции
- Создание MVP в течение 4-6 недель

## 2. Технический стек и архитектура

### 2.1 Основной стек технологий

```bash
Backend Framework: aiogram 3.x (асинхронный фреймворк для Telegram Bot API)
Language: Python 3.11+
Database: PostgreSQL 15+ (основная БД)
ORM: SQLAlchemy 2.0+ с async поддержкой
Migration Tool: Alembic
HTTP Client: httpx (для OpenRouter API)
Environment: python-dotenv
Validation: Pydantic v2.11.7
Logging: Loguru
Dependency Management: uv
```

### 2.2 Архитектурные компоненты

**Слой представления:**
- Telegram Bot API Handler (aiogram dispatcher)
- Webhook/Polling механизм обработки обновлений
- Middleware для аутентификации, rate limiting, логирования и метрик

**Бизнес-логика:**
- Conversation Manager (управление диалогами)
- AI Response Generator (интеграция с OpenRouter)
- User State Management (управление состояниями пользователей)
- Payment Processing (обработка платежей)

**Слой данных:**
- Database Abstraction Layer (SQLAlchemy ORM)
- Repository Pattern для работы с данными

### 2.3 Система Middleware

Для централизации обработки запросов и уменьшения дублирования кода в обработчиках реализована система Middleware. Middleware компоненты обрабатывают запросы до и после их обработки основными обработчиками.

**Реализованные Middleware компоненты:**

1. **AuthMiddleware** - автоматическая аутентификация пользователей
   - Получает или создает пользователя в базе данных
   - Добавляет объект пользователя в контекст обработки

2. **UserLanguageMiddleware** - управление языком пользователя
   - Определяет язык пользователя на основе его настроек
   - Добавляет язык пользователя в контекст обработки

3. **AntiSpamMiddleware** - защита от спама
   - Ограничивает количество действий пользователя в минуту (по умолчанию 20 действий)
   - Временно блокирует пользователя при превышении лимита (по умолчанию 10 секунд)
   - Отправляет уведомление при превышении лимита

4. **RateLimitMiddleware** - ограничение частоты запросов
   - Ограничивает количество запросов от пользователя в минуту
   - Отправляет уведомление при превышении лимита

5. **LoggingMiddleware** - централизованное логирование
   - Логирует все входящие события
   - Собирает статистику по типам событий

6. **ConversationMiddleware** - сохранение диалогов
   - Предоставляет функции для сохранения диалогов в базе данных
   - Автоматически сохраняет диалоги при наличии соответствующих данных в контексте

7. **MessageCountingMiddleware** - подсчет сообщений пользователей и ограничение по лимиту
   - Подсчитывает количество сообщений от пользователей
   - Ограничивает количество сообщений в день для бесплатных пользователей (по умолчанию 20 сообщений)
   - Премиум пользователи не имеют ограничений по количеству сообщений
   - Отправляет уведомление при превышении дневного лимита с предложением приобрести премиум

8. **MetricsMiddleware** - сбор метрик использования
   - Собирает метрики по использованию бота
   - Предоставляет статистику по запросам

9. **AdminMiddleware** - проверка прав администратора
   - Проверяет, является ли пользователь администратором
   - Добавляет информацию о правах администратора в контекст обработки

10. **ContentFilterMiddleware** - фильтрация контента и обеспечение безопасности
    - Фильтрует сообщения на наличие запрещенного контента (экстремизм, незаконные материалы)
    - Предупреждает пользователей о попытке отправки персональных данных
    - Блокирует сообщения с незаконным контентом
    - Собирает статистику по фильтрации контента

11. **EmotionalProfilingMiddleware** - анализ эмоций пользователей и обновление их профилей
    - Анализирует эмоциональную окраску сообщений пользователей
    - Обновляет эмоциональный профиль пользователя в базе данных
    - Извлекает эмоциональные индикаторы (позитивные/негативные слова, интенсивность, темы)

**Порядок выполнения Middleware:**
1. LoggingMiddleware (первым для записи всех событий)
2. AuthMiddleware (для получения пользователя)
3. AdminMiddleware (для проверки прав администратора)
4. UserLanguageMiddleware (для определения языка)
5. AntiSpamMiddleware (защита от спама)
6. RateLimitMiddleware (ограничение частоты запросов)
7. ContentFilterMiddleware (фильтрация контента)
8. EmotionalProfilingMiddleware (профилирование эмоций пользователя)
9. ConversationMiddleware (для сохранения диалогов)
10. MessageCountingMiddleware (для подсчета сообщений и ограничения по лимиту)
11. MetricsMiddleware (последним для сбора полной информации)

### 2.4 Платежная система

Для монетизации проекта реализована система платежей через Telegram Stars. Платежная система позволяет пользователям приобретать премиум подписку для получения расширенных возможностей.

**Компоненты платежной системы:**

1. **Payment Model** - модель данных для хранения информации о платежах
2. **TelegramStarsPaymentService** - сервис для обработки платежей и управления премиум подписками
3. **Payment Handlers** - обработчики для создания инвойсов и обработки успешных платежей
4. **Payment Configuration** - настройки платежной системы через переменные окружения

**Функциональность:**
- Создание инвойсов для оплаты Telegram Stars
- Обработка успешных платежей
- Активация и продление премиум подписок
- Проверка статуса премиум подписки
- Хранение истории платежей в базе данных

### 2.6 Система мониторинга и аналитики

Для обеспечения высокой доступности и отслеживания производительности реализована система мониторинга и аналитики.

**Компоненты системы мониторинга:**

1. **HealthCheckService** - сервис проверки здоровья системы
2. **MonitoringService** - сервис мониторинга производительности
3. **AnalyticsService** - сервис аналитики и сбора метрик
4. **Web API Endpoints** - конечные точки для получения метрик и статуса системы

**Функциональность:**
- Периодическая проверка здоровья всех компонентов системы
- Сбор метрик производительности (CPU, память, диск, сеть)
- Анализ пользовательской активности и вовлеченности
- Отправка уведомлений при проблемах с системой
- Предоставление аналитических отчетов

### 2.7 Система масштабирования и высокой доступности

Для обеспечения масштабируемости и высокой доступности бота реализована система конфигурации для горизонтального масштабирования и балансировки нагрузки.

**Компоненты системы масштабирования:**

1. **LoadBalancerConfig** - конфигурация балансировщика нагрузки
2. **ScalingConfig** - конфигурация параметров масштабирования
3. **Load Testing Scripts** - скрипты для нагрузочного тестирования

**Функциональность:**
- Поддержка горизонтального масштабирования
- Настройка балансировки нагрузки между экземплярами
- Конфигурация автоматического масштабирования
- Поддержка кэширования и очередей сообщений
- Распределенная блокировка для координации между экземплярами

### 2.4 Структура проекта

```
ai_assist/
├── app/                        # Основной пакет приложения
│   ├── __init__.py            # Инициализация пакета
│   ├── main.py                # Точка входа
│   ├── config.py              # Настройки приложения
│   ├── database.py            # Подключение к БД
│   ├── config/                # Конфигурационные файлы
│   │   ├── load_balancer.py   # Конфигурация балансировщика нагрузки
│   │   └── scaling.py         # Конфигурация масштабирования
│   ├── models/                # Модели данных
│   │   ├── __init__.py
│   │   ├── user.py           # Модель пользователя
│   │   ├── payment.py        # Модель платежей
│   │   └── conversation.py   # Модель диалога
│   ├── handlers/              # Обработчики команд
│   │   ├── __init__.py
│   │   ├── start.py          # /start команда
│   │   ├── language.py       # /language команда
│   │   ├── help.py           # /help команда
│   │   ├── profile.py        # /profile команда
│   │   ├── limits.py         # /limits команда
│   │   ├── premium.py        # /premium команда
│   │   ├── message.py        # Обработка сообщений
│   │   ├── callbacks.py      # Обработка callback-запросов
│   │   ├── health.py         # Healthcheck endpoint
│   │   └── admin.py          # Админские команды
│   ├── middleware/            # Middleware компоненты
│   │   ├── __init__.py
│   │   ├── base.py           # Базовый класс middleware
│   │   ├── auth.py           # Аутентификация пользователей
│   │   ├── rate_limit.py     # Ограничение частоты запросов
│   │   ├── logging.py        # Централизованное логирование
│   │   ├── user_language.py  # Управление языком пользователя
│   │   ├── conversation.py   # Сохранение диалогов
│   │   ├── user_counter.py   # Подсчет сообщений пользователей
│   │   ├── metrics.py        # Сбор метрик использования
│   │   ├── content_filter.py # Фильтрация контента и обеспечение безопасности
│   │   └── emotional_profiling.py # Анализ эмоций пользователей
│   ├── services/              # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── ai_manager.py     # Менеджер AI провайдеров (единственный AI сервис)
│   │   ├── conversation_service.py # Сервис работы с диалогами
│   │   ├── user_service.py   # Логика пользователей
│   │   ├── payment_service.py # Обработка платежей Telegram Stars
│   │   ├── health_check.py   # Сервис проверки здоровья системы
│   │   ├── monitoring.py     # Сервис мониторинга производительности
│   │   └── analytics.py      # Сервис аналитики
│   │   └── ai_providers/     # Провайдеры AI
│   │       ├── __init__.py
│   │       ├── base.py       # Базовый класс провайдера
│   │       └── openrouter.py # OpenRouter провайдер
│   ├── utils/                 # Утилиты
│   │   ├── __init__.py
│   │   └── logging.py        # Система логирования
│   ├── keyboards/             # Клавиатуры
│   │   └── __init__.py       # Inline клавиатуры
│   ├── constants/             # Константы (модульная структура)
│   │   ├── __init__.py
│   │   ├── config.py         # Константы конфигурации
│   │   └── errors.py         # Константы ошибок
│   ├── lexicon/               # Лексиконы (модульная структура)
│   │   ├── __init__.py
│   │   ├── gettext.py        # Функции локализации
│   │   ├── ru.py             # Русский лексикон
│   │   └── en.py             # Английский лексикон
│   └── log_lexicon/           # Лог-лексиконы (модульная структура)
│       ├── __init__.py
│       ├── en.py             # Английский лог-лексикон (словарная структура)
│       └── ru.py             # Русский лог-лексикон (словарная структура)
├── tests/                      # Тесты приложения
│   ├── __init__.py            # Инициализация пакета тестов
│   ├── conftest.py           # Конфигурация pytest
│   ├── fixtures/             # Фикстуры для тестов
│   ├── unit/                 # Модульные тесты
│   └── integration/          # Интеграционные тесты
├── scripts/                    # Скрипты диагностики
│   ├── __init__.py
│   ├── checks/               # Скрипты проверки
│   └── diagnostics/          # Диагностические скрипты
├── docs/                      # Документация
│   ├── Project.md            # Описание проекта (этот файл)
│   ├── Tasktracker.md        # Отслеживание задач
│   ├── Testing.md            # Документация по тестированию
│   ├── Deployment.md         # Документация по развертыванию
│   ├── Payment.md            # Документация по платежной системе
│   ├── changelog.md          # Журнал изменений
│   ├── testing_strategy.md   # Стратегия тестирования
│   └── Diary.md              # Дневник разработки
├── alembic/                    # Миграции базы данных
└── requirements.txt            # Зависимости проекта