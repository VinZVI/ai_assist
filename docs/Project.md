# AI-Компаньон: Telegram-бот для эмоциональной поддержки

## 1. Общие сведения о проекте

### 1.1 Назначение системы

Telegram-бот для предоставления эмоциональной поддержки и психологического комфорта пользователям с интеграцией OpenRout API для генерации ответов на базе искусственного интеллекта.

### 1.2 Цели проекта

- Создание масштабируемого сервиса для психологической поддержки
- Обеспечение высокой доступности (99.9% uptime)
- Монетизация через премиум функции
- Создание MVP в течение 4-6 недель

## 2. Технический стек и архитектура

### 2.1 Основной стек технологий

```bash
Backend Framework: aiogram 3.x (асинхронный фреймворк для Telegram Bot API)
Language: Python 3.11+
Database: PostgreSQL 15+ (основная БД)
ORM: SQLAlchemy 2.0+ с async поддержкой
Migration Tool: Alembic
HTTP Client: httpx (для OpenRouter API)
Environment: python-dotenv
Validation: Pydantic v2.11.7
Logging: Loguru
Dependency Management: uv
```

### 2.2 Архитектурные компоненты

**Слой представления:**
- Telegram Bot API Handler (aiogram dispatcher)
- Webhook/Polling механизм обработки обновлений
- Middleware для аутентификации, rate limiting, логирования и метрик

**Бизнес-логика:**
- Conversation Manager (управление диалогами)
- AI Response Generator (интеграция с OpenRouter)
- User State Management (управление состояниями пользователей)
- Payment Processing (обработка платежей)

**Слой данных:**
- Database Abstraction Layer (SQLAlchemy ORM)
- Repository Pattern для работы с данными

### 2.3 Система Middleware

Для централизации обработки запросов и уменьшения дублирования кода в обработчиках реализована система Middleware. Middleware компоненты обрабатывают запросы до и после их обработки основными обработчиками.

**Реализованные Middleware компоненты:**

1. **AuthMiddleware** - автоматическая аутентификация пользователей
   - Получает или создает пользователя в базе данных
   - Добавляет объект пользователя в контекст обработки

2. **UserLanguageMiddleware** - управление языком пользователя
   - Определяет язык пользователя на основе его настроек
   - Добавляет язык пользователя в контекст обработки

3. **AntiSpamMiddleware** - защита от спама
   - Ограничивает количество действий пользователя в минуту (по умолчанию 20 действий)
   - Временно блокирует пользователя при превышении лимита (по умолчанию 10 секунд)
   - Отправляет уведомление при превышении лимита

4. **RateLimitMiddleware** - ограничение частоты запросов
   - Ограничивает количество запросов от пользователя в минуту
   - Отправляет уведомление при превышении лимита

5. **LoggingMiddleware** - централизованное логирование
   - Логирует все входящие события
   - Собирает статистику по типам событий

6. **ConversationMiddleware** - сохранение диалогов
   - Предоставляет функции для сохранения диалогов в базе данных
   - Автоматически сохраняет диалоги при наличии соответствующих данных в контексте

7. **MessageCountingMiddleware** - подсчет сообщений пользователей и ограничение по лимиту
   - Подсчитывает количество сообщений от пользователей
   - Ограничивает количество сообщений в день для бесплатных пользователей (по умолчанию 20 сообщений)
   - Премиум пользователи не имеют ограничений по количеству сообщений
   - Отправляет уведомление при превышении дневного лимита с предложением приобрести премиум

8. **MetricsMiddleware** - сбор метрик использования
   - Собирает метрики по использованию бота
   - Предоставляет статистику по запросам

9. **AdminMiddleware** - проверка прав администратора
   - Проверяет, является ли пользователь администратором
   - Добавляет информацию о правах администратора в контекст обработки

**Порядок выполнения Middleware:**
1. LoggingMiddleware (первым для записи всех событий)
2. AuthMiddleware (для получения пользователя)
3. AdminMiddleware (для проверки прав администратора)
4. UserLanguageMiddleware (для определения языка)
5. AntiSpamMiddleware (защита от спама)
6. RateLimitMiddleware (ограничение частоты запросов)
7. ConversationMiddleware (для сохранения диалогов)
8. MessageCountingMiddleware (для подсчета сообщений и ограничения по лимиту)
9. MetricsMiddleware (последним для сбора полной информации)

### 2.4 Платежная система

Для монетизации проекта реализована система платежей через Telegram Stars. Платежная система позволяет пользователям приобретать премиум подписку для получения расширенных возможностей.

**Компоненты платежной системы:**

1. **Payment Model** - модель данных для хранения информации о платежах
2. **TelegramStarsPaymentService** - сервис для обработки платежей и управления премиум подписками
3. **Payment Handlers** - обработчики для создания инвойсов и обработки успешных платежей
4. **Payment Configuration** - настройки платежной системы через переменные окружения

**Функциональность:**
- Создание инвойсов для оплаты Telegram Stars
- Обработка успешных платежей
- Активация и продление премиум подписок
- Проверка статуса премиум подписки
- Хранение истории платежей в базе данных

### 2.4 Структура проекта

```
ai_assist/
├── app/                        # Основной пакет приложения
│   ├── __init__.py            # Инициализация пакета
│   ├── main.py                # Точка входа
│   ├── config.py              # Настройки приложения
│   ├── database.py            # Подключение к БД
│   ├── models/                # Модели данных
│   │   ├── __init__.py
│   │   ├── user.py           # Модель пользователя
│   │   ├── payment.py        # Модель платежей
│   │   └── conversation.py   # Модель диалога
│   ├── handlers/              # Обработчики команд
│   │   ├── __init__.py
│   │   ├── start.py          # /start команда
│   │   ├── language.py       # /language команда
│   │   ├── help.py           # /help команда
│   │   ├── profile.py        # /profile команда
│   │   ├── limits.py         # /limits команда
│   │   ├── premium.py        # /premium команда
│   │   ├── message.py        # Обработка сообщений
│   │   ├── callbacks.py      # Обработка callback-запросов
│   │   ├── health.py         # Healthcheck endpoint
│   │   └── admin.py          # Админские команды
│   ├── middleware/            # Middleware компоненты
│   │   ├── __init__.py
│   │   ├── base.py           # Базовый класс middleware
│   │   ├── auth.py           # Аутентификация пользователей
│   │   ├── rate_limit.py     # Ограничение частоты запросов
│   │   ├── logging.py        # Централизованное логирование
│   │   ├── user_language.py  # Управление языком пользователя
│   │   ├── conversation.py   # Сохранение диалогов
│   │   ├── user_counter.py   # Подсчет сообщений пользователей
│   │   └── metrics.py        # Сбор метрик использования
│   ├── services/              # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── ai_manager.py     # Менеджер AI провайдеров (единственный AI сервис)
│   │   ├── conversation_service.py # Сервис работы с диалогами
│   │   ├── user_service.py   # Логика пользователей
│   │   ├── payment_service.py # Обработка платежей Telegram Stars
│   │   └── ai_providers/     # Провайдеры AI
│   │       ├── __init__.py
│   │       ├── base.py       # Базовый класс провайдера
│   │       └── openrouter.py # OpenRouter провайдер
│   ├── utils/                 # Утилиты
│   │   ├── __init__.py
│   │   └── logging.py        # Система логирования
│   ├── keyboards/             # Клавиатуры
│   │   └── __init__.py       # Inline клавиатуры
│   ├── constants/             # Константы (модульная структура)
│   │   ├── __init__.py
│   │   ├── config.py         # Константы конфигурации
│   │   └── errors.py         # Константы ошибок
│   ├── lexicon/               # Лексиконы (модульная структура)
│   │   ├── __init__.py
│   │   ├── gettext.py        # Функции локализации
│   │   ├── ru.py             # Русский лексикон
│   │   └── en.py             # Английский лексикон
│   └── log_lexicon/           # Лог-лексиконы (модульная структура)
│       ├── __init__.py
│       ├── en.py             # Английский лог-лексикон (словарная структура)
│       └── ru.py             # Русский лог-лексикон (словарная структура)
├── tests/                      # Тесты приложения
│   ├── __init__.py            # Инициализация пакета тестов
│   ├── conftest.py           # Конфигурация pytest
│   ├── fixtures/             # Фикстуры для тестов
│   ├── unit/                 # Модульные тесты
│   └── integration/          # Интеграционные тесты
├── scripts/                    # Скрипты диагностики
│   ├── __init__.py
│   ├── checks/               # Скрипты проверки
│   └── diagnostics/          # Диагностические скрипты
├── docs/                      # Документация
│   ├── Project.md            # Описание проекта (этот файл)
│   ├── Tasktracker.md        # Отслеживание задач
│   ├── Diary.md              # Дневник разработки
│   ├── Testing.md            # Документация по тестированию
│   ├── Deployment.md         # Документация по деплою
│   ├── Docker.md             # Документация по Docker
│   ├── Payment.md            # Документация по платежной системе
│   └── changelog.md          # Журнал изменений
├── alembic/                    # Миграции базы данных
├── logs/                       # Логи приложения
├── .github/                    # GitHub Actions workflows
├── pyproject.toml            # Конфигурация проекта и зависимости
├── pytest.ini               # Конфигурация тестирования
├── .env.example              # Пример переменных окружения
├── docker-compose.yml        # Docker конфигурация
└── README.md                 # Основная документация проекта
```

## 3. AI сервис и интеграция

### 3.1 Архитектура AI сервиса с одним провайдером

**Система поддерживает одного AI провайдера с автоматическим fallback между моделями:**

**Основные компоненты:**
- `AIManager` - центральный менеджер для управления провайдером
- `BaseAIProvider` - абстрактный базовый класс для всех провайдеров
- `OpenRouterProvider` - провайдер для OpenRouter API
- `ResponseCache` - система кеширования ответов
- `ConversationMessage` - структура для сообщений диалога
- `AIResponse` - структура ответа от AI

**Поддерживаемые провайдеры:**
1. **OpenRouter API** - основной провайдер

**Особенности реализации:**
- Автоматический fallback между моделями внутри провайдера
- Асинхронная работа с httpx клиентом
- Retry логика с экспоненциальной задержкой
- Обработка различных типов ошибок (401, 402, 429, 5xx)
- Кеширование ответов на основе MD5 хешей
- Мониторинг состояния через `health_check()` для провайдера
- Статистика использования и fallback событий

### 3.2 Конфигурация AI сервиса

```
# Настройки OpenRouter API
OPENROUTER_API_KEY=your_openrouter_api_key_here
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
OPENROUTER_MODEL='["openrouter/default-model", "openrouter/alternative-model"]'
OPENROUTER_MAX_TOKENS=1000
OPENROUTER_TEMPERATURE=0.8
OPENROUTER_TIMEOUT=60
OPENROUTER_SITE_URL=https://your-site.com
OPENROUTER_APP_NAME=AI-Assistant-Bot

# Настройки AI менеджера
AI_PRIMARY_PROVIDER=openrouter
AI_ENABLE_FALLBACK=true

# Настройки кеширования
CACHE_TTL=3600
```

### 3.3 Форматирование и санитизация сообщений

**Особенности реализации:**
- Системные промпты AI содержат инструкции по форматированию ответов в соответствии с ограничениями Telegram
- Санитизация ответов AI для удаления специальных символов и контроль длины сообщений
- Ограничение длины сообщений до 4096 символов (лимит Telegram)
- Удаление специальных символов, которые могут вызвать ошибки парсинга в Telegram
- Использование только простого текста без форматирования

### 3.4 Обработка ошибок и Fallback система

**Иерархия ошибок:**
- `AIProviderError` - базовый класс ошибок провайдеров
- `APIConnectionError` - ошибки подключения
- `APIRateLimitError` - превышение лимитов
- `APIAuthenticationError` - ошибки аутентификации
- `APIQuotaExceededError` - превышение квоты/недостаток средств