# AI-Компаньон: Telegram-бот для эмоциональной поддержки

## 1. Общие сведения о проекте

### 1.1 Назначение системы

Telegram-бот для предоставления эмоциональной поддержки и психологического комфорта пользователям с интеграцией OpenRout API для генерации ответов на базе искусственного интеллекта.

### 1.2 Цели проекта

- Создание масштабируемого сервиса для психологической поддержки
- Обеспечение высокой доступности (99.9% uptime)
- Монетизация через премиум функции
- Создание MVP в течение 4-6 недель

## 2. Технический стек и архитектура

### 2.1 Основной стек технологий

```bash
Backend Framework: aiogram 3.x (асинхронный фреймворк для Telegram Bot API)
Language: Python 3.11+
Database: PostgreSQL 15+ (основная БД)
ORM: SQLAlchemy 2.0+ с async поддержкой
Migration Tool: Alembic
HTTP Client: httpx (для OpenRouter API)
Environment: python-dotenv
Validation: Pydantic v2.11.7
Logging: Loguru
Dependency Management: uv
```

### 2.2 Архитектурные компоненты

**Слой представления:**
- Telegram Bot API Handler (aiogram dispatcher)
- Webhook/Polling механизм обработки обновлений
- Middleware для аутентификации, rate limiting, логирования и метрик

**Бизнес-логика:**
- Conversation Manager (управление диалогами)
- AI Response Generator (интеграция с OpenRouter)
- User State Management (управление состояниями пользователей)
- Payment Processing (обработка платежей)

**Слой данных:**
- Database Abstraction Layer (SQLAlchemy ORM)
- Repository Pattern для работы с данными

### 2.3 Система Middleware

Для централизации обработки запросов и уменьшения дублирования кода в обработчиках реализована система Middleware. Middleware компоненты обрабатывают запросы до и после их обработки основными обработчиками.

**Реализованные Middleware компоненты:**

1. **AuthMiddleware** - автоматическая аутентификация пользователей
   - Получает или создает пользователя в базе данных
   - Добавляет объект пользователя в контекст обработки
   - Кэширует пользователей для уменьшения нагрузки на базу данных

2. **UserLanguageMiddleware** - управление языком пользователя
   - Определяет язык пользователя на основе его настроек
   - Добавляет язык пользователя в контекст обработки

3. **AntiSpamMiddleware** - защита от спама
   - Ограничивает количество действий пользователя в минуту (по умолчанию 20 действий)
   - Временно блокирует пользователя при превышении лимита (по умолчанию 10 секунд)
   - Отправляет уведомление при превышении лимита

4. **RateLimitMiddleware** - ограничение частоты запросов
   - Ограничивает количество запросов от пользователя в минуту
   - Отправляет уведомление при превышении лимита

5. **LoggingMiddleware** - централизованное логирование
   - Логирует все входящие события
   - Собирает статистику по типам событий

6. **ConversationMiddleware** - сохранение диалогов
   - Предоставляет функции для сохранения диалогов в базе данных
   - Автоматически сохраняет диалоги при наличии соответствующих данных в контексте

7. **MessageCountingMiddleware** - подсчет сообщений пользователей и ограничение по лимиту
   - Подсчитывает количество сообщений от пользователей
   - Ограничивает количество сообщений в день для бесплатных пользователей (по умолчанию 20 сообщений)
   - Премиум пользователи не имеют ограничений по количеству сообщений
   - Отправляет уведомление при превышении дневного лимита с предложением приобрести премиум

8. **MetricsMiddleware** - сбор метрик использования
   - Собирает метрики по использованию бота
   - Предоставляет статистику по запросам

9. **AdminMiddleware** - проверка прав администратора
   - Проверяет, является ли пользователь администратором
   - Добавляет информацию о правах администратора в контекст обработки

10. **ContentFilterMiddleware** - фильтрация контента и обеспечение безопасности
    - Фильтрует сообщения на наличие запрещенного контента (экстремизм, незаконные материалы)
    - Предупреждает пользователей о попытке отправки персональных данных
    - Блокирует сообщения с незаконным контентом
    - Собирает статистику по фильтрации контента

11. **EmotionalProfilingMiddleware** - анализ эмоций пользователей и обновление их профилей
    - Анализирует эмоциональную окраску сообщений пользователей
    - Обновляет эмоциональный профиль пользователя в базе данных
    - Извлекает эмоциональные индикаторы (позитивные/негативные слова, интенсивность, темы)

**Порядок выполнения Middleware:**
1. LoggingMiddleware (первым для записи всех событий)
2. AuthMiddleware (для получения пользователя)
3. AdminMiddleware (для проверки прав администратора)
4. UserLanguageMiddleware (для определения языка)
5. AntiSpamMiddleware (защита от спама)
6. RateLimitMiddleware (ограничение частоты запросов)
7. ContentFilterMiddleware (фильтрация контента)
8. EmotionalProfilingMiddleware (профилирование эмоций пользователя)
9. ConversationMiddleware (для сохранения диалогов)
10. MessageCountingMiddleware (для подсчета сообщений и ограничения по лимиту)
11. MetricsMiddleware (последним для сбора полной информации)

### 2.4 Система Dependency Injection

Для устранения циркулярных импортов и улучшения архитектуры реализована система dependency injection.

**Компоненты DI системы:**

1. **DependencyContainer** - контейнер для управления зависимостями приложения
   - Регистрация singleton сервисов
   - Регистрация factory для создания сервисов
   - Получение сервисов по имени
   - Декораторы для внедрения зависимостей

2. **ServiceRegistry** - реестр сервисов приложения
   - Инициализация всех сервисов в правильном порядке
   - Централизованная настройка зависимостей

**Преимущества DI системы:**
- Устранение циркулярных импортов
- Улучшенная тестируемость компонентов
- Гибкость конфигурации сервисов
- Централизованное управление зависимостями

### 2.5 Система батчинга операций

Для оптимизации производительности реализована система пакетной обработки операций с БД.

**Компоненты системы батчинга:**

1. **BatchProcessor** - пакетный процессор для операций с БД
   - Пакетная вставка диалогов
   - Пакетное обновление пользователей
   - Механизмы retry при ошибках
   - Настраиваемые параметры батчинга

2. **BackgroundTaskManager** - менеджер фоновых задач
   - Управление фоновыми процессами
   - Мониторинг состояния системы
   - Очистка кэша и других ресурсов

### 2.6 Система мониторинга и аналитики

Для обеспечения высокой доступности и отслеживания производительности реализована система мониторинга и аналитики.

**Компоненты системы мониторинга:**

1. **PerformanceMonitor** - монитор производительности системы
   - Сбор системных метрик (CPU, память, диск)
   - Сбор метрик приложения (кэш, батч-процессор)
   - Сбор метрик базы данных
   - Система алертов для критичных метрик

2. **MetricsCollector** - централизованный коллектор метрик
   - Трекинг различных операций в системе
   - Декораторы для измерения времени выполнения
   - Контекстные менеджеры для тайминга

3. **Web Dashboard** - веб-дашборд метрик
   - Визуализация метрик в реальном времени
   - Отображение активных алертов
   - API эндпоинты для получения метрик

### 2.7 Платежная система

Для монетизации проекта реализована система платежей через Telegram Stars. Платежная система позволяет пользователям приобретать премиум подписку для получения расширенных возможностей.

**Компоненты платежной системы:**

1. **Payment Model** - модель данных для хранения информации о платежах
2. **TelegramStarsPaymentService** - сервис для обработки платежей и управления премиум подписками
3. **Payment Handlers** - обработчики для создания инвойсов и обработки успешных платежей
4. **Payment Configuration** - настройки платежной системы через переменные окружения

**Функциональность:**
- Создание инвойсов для оплаты Telegram Stars
- Обработка успешных платежей
- Активация и продление премиум подписок
- Проверка статуса премиум подписки
- Хранение истории платежей в базе данных

### 2.8 Система масштабирования и высокой доступности

Для обеспечения масштабируемости и высокой доступности бота реализована система конфигурации для горизонтального масштабирования и балансировки нагрузки.

**Компоненты системы масштабирования:**

1. **LoadBalancerConfig** - конфигурация балансировщика нагрузки
2. **ScalingConfig** - конфигурация параметров масштабирования
3. **Load Testing Scripts** - скрипты для нагрузочного тестирования

**Функциональность:**
- Поддержка горизонтального масштабирования
- Настройка балансировки нагрузки между экземплярами
- Конфигурация автоматического масштабирования
- Поддержка кэширования и очередей сообщений
- Распределенная блокировка для координации между экземплярами

### 2.4 Структура проекта

```bash
ai_assist/
├── app/                        # Основной пакет приложения
│   ├── __init__.py            # Инициализация пакета
│   ├── main.py                # Точка входа
│   ├── config.py              # Настройки приложения
│   ├── database.py            # Подключение к БД
│   ├── core/                  # Ядро приложения
│   │   ├── dependencies.py    # Система dependency injection
│   │   ├── service_registry.py # Реестр сервисов
│   │   └── background_tasks.py # Менеджер фоновых задач
│   ├── models/                # Модели данных
│   │   ├── __init__.py
│   │   ├── user.py           # Модель пользователя
│   │   ├── payment.py        # Модель платежей
│   │   └── conversation.py   # Модель диалога
│   ├── handlers/              # Обработчики команд
│   │   ├── __init__.py
│   │   ├── start.py          # /start команда
│   │   ├── language.py       # /language команда
│   │   ├── help.py           # /help команда
│   │   ├── profile.py        # /profile команда
│   │   ├── limits.py         # /limits команда
│   │   ├── premium.py        # /premium команда
│   │   ├── message.py        # Обработка сообщений
│   │   ├── callbacks.py      # Обработка callback-запросов
│   │   ├── health.py         # Healthcheck endpoint
│   │   └── admin.py          # Админские команды
│   ├── services/              # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── user_service.py   # Сервис пользователей
│   │   ├── conversation_service.py # Сервис диалогов (устаревший)
│   │   ├── conversation_service_new.py # Сервис диалогов (новый)
│   │   ├── ai_manager.py     # Менеджер AI провайдеров
│   │   ├── cache_service.py  # Сервис кэширования
│   │   ├── redis_cache_service.py # Redis кэш
│   │   ├── batch_processor.py # Пакетный процессор
│   │   ├── performance_monitor.py # Монитор производительности
│   │   └── metrics_collector.py # Коллектор метрик
│   ├── middleware/            # Middleware компоненты
│   │   ├── __init__.py
│   │   ├── auth.py           # Аутентификация
│   │   ├── rate_limit.py     # Ограничение частоты запросов
│   │   ├── anti_spam.py      # Защита от спама
│   │   ├── logging.py        # Логирование
│   │   ├── conversation.py   # Сохранение диалогов
│   │   ├── message_counting.py # Подсчет сообщений
│   │   ├── metrics.py        # Сбор метрик
│   │   ├── admin.py          # Проверка прав администратора
│   │   ├── content_filter.py # Фильтрация контента
│   │   └── emotional_profiling.py # Профилирование эмоций
│   ├── utils/                 # Утилиты
│   │   ├── __init__.py
│   │   ├── validators.py     # Валидаторы
│   │   ├── cache_keys.py     # Управление ключами кэша
│   │   ├── db_optimization.py # Оптимизация БД
│   │   └── helpers.py        # Вспомогательные функции
│   └── web.py                 # Веб-сервер и API
├── tests/                     # Тесты
│   ├── __init__.py
│   ├── conftest.py           # Конфигурация pytest
│   ├── unit/                 # Модульные тесты
│   ├── integration/          # Интеграционные тесты
│   └── fixtures/             # Фикстуры для тестов
├── docs/                      # Документация
│   ├── Project.md            # Основная документация
│   ├── Tasktracker.md        # Трекер задач
│   ├── changelog.md          # Журнал изменений
│   ├── Deployment.md         # Деплой и развертывание
│   ├── Docker.md             # Docker конфигурация
│   ├── Payment.md            # Документация по платежам
│   ├── Testing.md            # Стратегия тестирования
│   ├── caching-architecture.md # Архитектура кэширования
│   └── qa.md                 # Вопросы и ответы
├── alembic/                   # Миграции базы данных
│   ├── versions/             # Версии миграций
│   ├── env.py                # Конфигурация Alembic
│   └── script.py.mako        # Шаблон скрипта миграции
├── scripts/                   # Скрипты
│   ├── diagnostics/          # Диагностические скрипты
│   ├── checks/               # Скрипты проверки
│   ├── force_stop_bot.py     # Принудительная остановка бота
│   └── clear_webhook.py      # Очистка webhook
├── logs/                      # Логи приложения
├── .env                       # Переменные окружения
├── .env.example              # Пример переменных окружения
├── Dockerfile                 # Docker конфигурация
├── docker-compose.yml         # Docker Compose конфигурация
├── docker-compose.web.yml     # Docker Compose для веб-сервера
├── requirements.txt           # Зависимости Python
├── alembic.ini               # Конфигурация Alembic
├── pytest.ini                # Конфигурация pytest
└── README.md                 # Описание проекта
```