# Документация по структуре контекста диалога

## Обзор

Этот документ описывает структуру контекста диалога, реализованную в AI-Компаньон для оптимизации взаимодействия с пользователями. Структура контекста диалога хранит отдельно последние 5 сообщений пользователя и 5 ответов ИИ, что позволяет ИИ лучше понимать контекст разговора без перегрузки системы историческими данными.

## Структура контекста диалога

### UserAIConversationContext

Основная структура контекста диалога реализована в классе `UserAIConversationContext`, который находится в файле `app/services/ai_providers/base.py`. Эта структура автоматически ограничивает количество сообщений каждого типа до 5, сохраняя только самые последние сообщения.

#### Атрибуты

- **user_messages**: Список последних 5 сообщений пользователя
- **ai_responses**: Список последних 5 ответов ИИ
- **last_interaction**: Время последнего взаимодействия
- **topics**: Список обсуждаемых тем
- **emotional_tone**: Эмоциональный тон диалога

#### Методы

- **add_user_message(message)**: Добавление сообщения пользователя с автоматическим ограничением до 5 сообщений
- **add_ai_response(response)**: Добавление ответа ИИ с автоматическим ограничением до 5 ответов
- **get_combined_history()**: Получение объединенной истории сообщений в хронологическом порядке
- **to_dict()**: Преобразование контекста в словарь для сериализации
- **from_dict(data)**: Создание контекста из словаря

## Преимущества новой структуры

### 1. Оптимизация памяти
- Хранение только последних 5 сообщений каждого типа значительно снижает использование памяти
- Автоматическое удаление старых сообщений предотвращает накопление данных

### 2. Улучшенное понимание контекста
- Разделение на пользовательские сообщения и ответы ИИ позволяет ИИ лучше понимать структуру диалога
- Хронологическое упорядочение объединенной истории обеспечивает правильный контекст

### 3. Производительность
- Быстрый доступ к последним сообщениям без необходимости обработки всей истории
- Эффективная сериализация и десериализация данных

## Реализация в системе

### 1. Хранение в кэше
Контекст диалога хранится в многоуровневом кэше:
- **MemoryCache**: Быстрый доступ к часто используемым данным
- **RedisCache**: Постоянное хранение между перезапусками приложения

### 2. Сохранение в базе данных
Контекст периодически сохраняется в базе данных:
- Сохранение происходит только из кэша после 10 минут неактивности пользователя
- Используется система персистентности `ConversationPersistence` для надежного хранения

### 3. Восстановление при перезапуске
При перезапуске приложения контекст автоматически восстанавливается:
- Восстановление из Redis кэша при старте приложения
- Fallback на базу данных при отсутствии данных в кэше

## Использование в обработчике сообщений

### Получение контекста
```python
# Получение контекста из кэша
conversation_context = await cache_service.get_conversation_context(
    user.id, context_limit, context_max_age
)

# Создание объекта контекста из словаря
if conversation_context and isinstance(conversation_context, dict):
    context_obj = UserAIConversationContext.from_dict(conversation_context)
    history = context_obj.get_combined_history()
```

### Сохранение контекста
```python
# Добавление новых сообщений в контекст
context.add_user_message(
    ConversationMessage(
        role="user", content=user_message, timestamp=datetime.now(UTC)
    )
)

context.add_ai_response(
    ConversationMessage(
        role="assistant", content=ai_response, timestamp=datetime.now(UTC)
    )
)

# Сохранение контекста в кэш
await conversation_service.save_conversation_with_cache(
    user_id=user.id,
    user_message=user_message,
    ai_response=ai_response,
    ai_model=response.model,
    tokens_used=response.tokens_used,
    response_time=response_time,
)
```

## Конфигурация

Система контекста диалога настраивается через переменные окружения в файле `.env`:

```env
# Включение сохранения диалогов
CONVERSATION_ENABLE_SAVING=true

# Время жизни кэша в секундах (10 минут)
CONVERSATION_CACHE_TTL=600

# Интервал обновления активности пользователя в секундах (5 минут)
USER_ACTIVITY_UPDATE_INTERVAL=300
```

## Мониторинг и отладка

### Статистика кэша
Для мониторинга производительности кэша можно использовать:
```python
# Получение статистики кэша
stats = cache_service.get_cache_stats()
print(f"Cache hit rate: {stats['memory_cache']['hit_rate']}")
```

### Логирование
Система автоматически логирует операции с контекстом:
- Создание и обновление контекста
- Ошибки при сохранении и восстановлении
- Статистика производительности

## Тестирование

### Юнит-тесты
Реализованы тесты для проверки:
- Инициализации контекста
- Ограничения количества сообщений до 5
- Объединения истории в хронологическом порядке
- Сериализации и десериализации

### Интеграционные тесты
Реализованы тесты для проверки:
- Потока работы с контекстом для нескольких пользователей
- Структуры контекста диалога
- Сохранения и восстановления контекста

## Будущие улучшения

### 1. Расширенная аналитика
- Анализ тем и эмоционального тона диалога
- Предсказание потребностей пользователя на основе истории

### 2. Адаптивное ограничение
- Динамическое изменение лимита сообщений в зависимости от активности пользователя
- Персонализация на основе предпочтений пользователя

### 3. Расширенное кэширование
- Прогрев кэша для активных пользователей
- Интеллектуальное аннулирование кэша

## Заключение

Новая структура контекста диалога значительно улучшает производительность и качество взаимодействия с пользователями. Автоматическое ограничение количества сообщений и разделение на пользовательские сообщения и ответы ИИ позволяет эффективно управлять контекстом диалога без перегрузки системы.